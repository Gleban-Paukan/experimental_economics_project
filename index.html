<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–≠–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–π —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç: –î–∏–ª–µ–º–º–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∏–∑–¥–µ—Ä–∂–µ–∫</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .main-container {
            max-width: 900px;
            margin: 30px auto;
            padding: 20px;
        }
        .game-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            animation: fadeIn 0.5s;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .room-code {
            font-size: 2.5rem;
            font-weight: bold;
            color: #667eea;
            letter-spacing: 5px;
            cursor: pointer;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            transition: all 0.3s;
        }
        .room-code:hover {
            background: #e9ecef;
            transform: scale(1.05);
        }
        .player-item {
            padding: 15px;
            margin: 10px 0;
            background: #f8f9fa;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .player-ready {
            background: #d4edda;
            border: 2px solid #28a745;
        }
        .slider-container {
            margin: 30px 0;
        }
        .contribution-value {
            font-size: 2rem;
            color: #667eea;
            font-weight: bold;
        }
        .results-table {
            margin-top: 20px;
        }
        .success-badge {
            background: #28a745;
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 1.2rem;
        }
        .fail-badge {
            background: #dc3545;
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 1.2rem;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            padding: 12px 30px;
            font-size: 1.1rem;
            border-radius: 10px;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .progress-bar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .waiting-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="game-card" id="gameContainer">
            <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –±—É–¥–µ—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å -->
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // FIREBASE –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø (–£–ñ–ï –ü–û–î–°–¢–ê–í–õ–ï–ù–ê)
        const firebaseConfig = {
            apiKey: "AIzaSyBdqtRnPhfqgYJYSMR5TZucmVHTuE4WTY8",
            authDomain: "cost-sharing-game.firebaseapp.com",
            databaseURL: "https://cost-sharing-game-default-rtdb.firebaseio.com",
            projectId: "cost-sharing-game",
            storageBucket: "cost-sharing-game.firebasestorage.app",
            messagingSenderId: "882128282715",
            appId: "1:882128282715:web:2fc86b8c68cbf3ccc44b7e"
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let playerName = '';
        let playerId = '';
        let roomCode = '';
        let isHost = false;
        let currentRoomRef = null;

        // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–≥—Ä—ã
        const GAME_PARAMS = {
            maxPlayers: 4,
            numRounds: 5,
            initialCapital: 100,
            benefitValue: 200,
            individualBenefit: 50,
            possibleCosts: [60, 80, 100, 120, 140]
        };

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ ID –∏–≥—Ä–æ–∫–∞
        function generatePlayerId() {
            return 'player_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–¥–∞ –∫–æ–º–Ω–∞—Ç—ã
        function generateRoomCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        // –≠–ö–†–ê–ù 1: –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω
        function showHomeScreen() {
            const container = document.getElementById('gameContainer');
            container.innerHTML = `
                <h1 class="text-center mb-4">–ú–Ω–æ–≥–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–π —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç</h1>
                <p class="text-center text-muted mb-4">–î–∏–ª–µ–º–º–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∏–∑–¥–µ—Ä–∂–µ–∫</p>
                
                <div class="mb-4">
                    <label class="form-label">–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è:</label>
                    <input type="text" id="playerNameInput" class="form-control" placeholder="–í–∞—à–µ –∏–º—è">
                </div>

                <div class="d-grid gap-3">
                    <button class="btn btn-primary btn-lg" onclick="createRoom()">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∫–æ–º–Ω–∞—Ç—É</button>
                    <div class="text-center">–∏–ª–∏</div>
                    <div class="input-group">
                        <input type="text" id="joinRoomInput" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∫–æ–º–Ω–∞—Ç—ã" maxlength="6">
                        <button class="btn btn-primary" onclick="joinRoom()">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
                    </div>
                </div>

                <div class="mt-5">
                    <h5>–ö—Ä–∞—Ç–∫–∏–µ –ø—Ä–∞–≤–∏–ª–∞:</h5>
                    <ul class="text-muted">
                        <li>–í –≥—Ä—É–ø–ø–µ 4 –∏–≥—Ä–æ–∫–∞</li>
                        <li>5 —Ä–∞—É–Ω–¥–æ–≤</li>
                        <li>–ö–∞–∂–¥—ã–π —Ä–∞—É–Ω–¥: –ø—Ä–æ–≥–Ω–æ–∑ –∏–∑–¥–µ—Ä–∂–µ–∫ ‚Üí –≤–∑–Ω–æ—Å</li>
                        <li>–ï—Å–ª–∏ —Å—É–º–º–∞ –≤–∑–Ω–æ—Å–æ–≤ ‚â• –∏–∑–¥–µ—Ä–∂–∫–∏ ‚Üí –ø—Ä–æ–µ–∫—Ç —Å–æ–∑–¥–∞–Ω</li>
                        <li>–¶–µ–ª—å: –º–∞–∫—Å–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–≤–æ–π –∏—Ç–æ–≥–æ–≤—ã–π —Å—á–µ—Ç</li>
                    </ul>
                </div>
            `;
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã
        function createRoom() {
            playerName = document.getElementById('playerNameInput').value.trim();
            if (!playerName) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è');
                return;
            }

            playerId = generatePlayerId();
            roomCode = generateRoomCode();
            isHost = true;

            const roomData = {
                status: 'waiting',
                currentRound: 1,
                host: playerId,
                createdAt: Date.now(),
                players: {}
            };

            roomData.players[playerId] = {
                name: playerName,
                score: 0,
                ready: false,
                online: true,
                joinedAt: Date.now()
            };

            database.ref(`rooms/${roomCode}`).set(roomData).then(() => {
                currentRoomRef = database.ref(`rooms/${roomCode}`);
                setupPresence();
                listenToRoom();
                showLobby();
            }).catch(error => {
                alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–Ω–∞—Ç—ã: ' + error.message);
            });
        }

        // –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ –∫–æ–º–Ω–∞—Ç–µ
        function joinRoom() {
            playerName = document.getElementById('playerNameInput').value.trim();
            const code = document.getElementById('joinRoomInput').value.trim().toUpperCase();

            if (!playerName) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è');
                return;
            }

            if (code.length !== 6) {
                alert('–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å 6 —Å–∏–º–≤–æ–ª–æ–≤');
                return;
            }

            roomCode = code;
            playerId = generatePlayerId();

            database.ref(`rooms/${roomCode}`).once('value', snapshot => {
                if (!snapshot.exists()) {
                    alert('–ö–æ–º–Ω–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                    return;
                }

                const roomData = snapshot.val();
                const playerCount = Object.keys(roomData.players || {}).length;

                if (playerCount >= GAME_PARAMS.maxPlayers) {
                    alert('–ö–æ–º–Ω–∞—Ç–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞ (–º–∞–∫—Å–∏–º—É–º 4 –∏–≥—Ä–æ–∫–∞)');
                    return;
                }

                database.ref(`rooms/${roomCode}/players/${playerId}`).set({
                    name: playerName,
                    score: 0,
                    ready: false,
                    online: true,
                    joinedAt: Date.now()
                }).then(() => {
                    currentRoomRef = database.ref(`rooms/${roomCode}`);
                    setupPresence();
                    listenToRoom();
                    showLobby();
                }).catch(error => {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ' + error.message);
                });
            });
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ presence (–æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –æ–Ω–ª–∞–π–Ω)
        function setupPresence() {
            const playerRef = database.ref(`rooms/${roomCode}/players/${playerId}`);
            playerRef.child('online').onDisconnect().set(false);
        }

        // –°–ª—É—à–∞—Ç–µ–ª—å –∏–∑–º–µ–Ω–µ–Ω–∏–π –∫–æ–º–Ω–∞—Ç—ã
        function listenToRoom() {
            currentRoomRef.on('value', snapshot => {
                if (!snapshot.exists()) {
                    alert('–ö–æ–º–Ω–∞—Ç–∞ –±—ã–ª–∞ —É–¥–∞–ª–µ–Ω–∞');
                    showHomeScreen();
                    return;
                }

                const roomData = snapshot.val();
                console.log('Room update:', roomData.status, 'Round:', roomData.currentRound);

                if (roomData.status === 'waiting') {
                    showLobby();
                } else if (roomData.status === 'playing') {
                    const playerData = roomData.players[playerId];
                    
                    if (!playerData.belief) {
                        showBeliefScreen(roomData);
                    } else if (!playerData.contribution && playerData.contribution !== 0) {
                        showContributionScreen(roomData);
                    } else if (!playerData.ready) {
                        // –ò–≥—Ä–æ–∫ —Å–¥–µ–ª–∞–ª –≤–∫–ª–∞–¥, —Å—Ç–∞–≤–∏–º ready
                        database.ref(`rooms/${roomCode}/players/${playerId}/ready`).set(true);
                        showWaitingScreen(roomData);
                    } else if (roomData.roundResults) {
                        showRoundResults(roomData);
                    } else {
                        showWaitingScreen(roomData);
                    }
                } else if (roomData.status === 'finished') {
                    showFinalResults(roomData);
                }
            });
        }

        // –≠–ö–†–ê–ù 2: –õ–æ–±–±–∏
        function showLobby() {
            currentRoomRef.once('value', snapshot => {
                const roomData = snapshot.val();
                const players = roomData.players || {};
                const playerCount = Object.keys(players).length;
                const readyCount = Object.values(players).filter(p => p.ready).length;

                const container = document.getElementById('gameContainer');
                container.innerHTML = `
                    <h2 class="text-center mb-4">–ö–æ–º–Ω–∞—Ç–∞ –æ–∂–∏–¥–∞–Ω–∏—è</h2>
                    
                    <div class="text-center mb-4">
                        <p class="mb-2">–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã:</p>
                        <div class="room-code" onclick="copyRoomCode()" title="–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å">${roomCode}</div>
                        <small class="text-muted">–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</small>
                    </div>

                    <div class="mb-4">
                        <h5>–ò–≥—Ä–æ–∫–∏ –≤ –∫–æ–º–Ω–∞—Ç–µ (${playerCount}/${GAME_PARAMS.maxPlayers}):</h5>
                        <div id="playersList"></div>
                    </div>

                    <div class="mb-4">
                        <div class="progress" style="height: 30px;">
                            <div class="progress-bar" role="progressbar" style="width: ${(readyCount/GAME_PARAMS.maxPlayers)*100}%">
                                –ò–≥—Ä–æ–∫–æ–≤ –≥–æ—Ç–æ–≤–æ: ${readyCount}/${GAME_PARAMS.maxPlayers}
                            </div>
                        </div>
                    </div>

                    <div class="d-grid gap-2">
                        <button class="btn btn-primary btn-lg" id="readyBtn" onclick="setReady()">
                            ${players[playerId]?.ready ? '‚úì –í—ã –≥–æ—Ç–æ–≤—ã!' : '–Ø –≥–æ—Ç–æ–≤!'}
                        </button>
                        <button class="btn btn-outline-secondary" onclick="leaveRoom()">–ü–æ–∫–∏–Ω—É—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
                    </div>

                    ${playerCount === GAME_PARAMS.maxPlayers && readyCount === GAME_PARAMS.maxPlayers ? 
                        '<div class="alert alert-success mt-3">–í—Å–µ –≥–æ—Ç–æ–≤—ã! –ò–≥—Ä–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è...</div>' : 
                        '<div class="alert alert-info mt-3">–û–∂–∏–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤...</div>'}
                `;

                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤
                const playersListDiv = document.getElementById('playersList');
                Object.entries(players).forEach(([pid, player]) => {
                    const isCurrentPlayer = pid === playerId;
                    const statusIcon = player.ready ? '‚úÖ' : '‚è≥';
                    const statusText = player.ready ? '–ì–æ—Ç–æ–≤' : '–û–∂–∏–¥–∞–Ω–∏–µ';
                    
                    playersListDiv.innerHTML += `
                        <div class="player-item ${player.ready ? 'player-ready' : ''}">
                            <span>${statusIcon} ${player.name} ${isCurrentPlayer ? '(–í—ã)' : ''}</span>
                            <span class="badge bg-secondary">${statusText}</span>
                        </div>
                    `;
                });

                // –ê–≤—Ç–æ—Å—Ç–∞—Ä—Ç
                if (isHost && playerCount === GAME_PARAMS.maxPlayers && readyCount === GAME_PARAMS.maxPlayers) {
                    setTimeout(() => startGame(), 2000);
                }
            });
        }

        function copyRoomCode() {
            navigator.clipboard.writeText(roomCode);
            alert('–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω: ' + roomCode);
        }

        function setReady() {
            database.ref(`rooms/${roomCode}/players/${playerId}/ready`).set(true);
        }

        function leaveRoom() {
            if (currentRoomRef) {
                currentRoomRef.off();
                database.ref(`rooms/${roomCode}/players/${playerId}`).remove();
            }
            showHomeScreen();
        }

        function startGame() {
            database.ref(`rooms/${roomCode}`).update({
                status: 'playing',
                currentRound: 1
            });
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º ready —É –≤—Å–µ—Ö
            currentRoomRef.child('players').once('value', snapshot => {
                const updates = {};
                snapshot.forEach(childSnapshot => {
                    updates[`players/${childSnapshot.key}/ready`] = false;
                    updates[`players/${childSnapshot.key}/belief`] = null;
                    updates[`players/${childSnapshot.key}/contribution`] = null;
                });
                database.ref(`rooms/${roomCode}`).update(updates);
            });
        }

        // –≠–ö–†–ê–ù 3: –û–ø—Ä–æ—Å –æ–∂–∏–¥–∞–Ω–∏–π
        function showBeliefScreen(roomData) {
            const container = document.getElementById('gameContainer');
            container.innerHTML = `
                <h2 class="text-center mb-4">–†–∞—É–Ω–¥ ${roomData.currentRound} –∏–∑ ${GAME_PARAMS.numRounds}</h2>
                
                <div class="alert alert-info">
                    <strong>–®–∞–≥ 1:</strong> –ö–∞–∫–∏–º–∏ –±—É–¥—É—Ç —Ä–µ–∞–ª—å–Ω—ã–µ –∏–∑–¥–µ—Ä–∂–∫–∏ –≤ —ç—Ç–æ–º —Ä–∞—É–Ω–¥–µ?
                </div>

                <div class="mb-4">
                    <h5>–í–∞—à –ø—Ä–æ–≥–Ω–æ–∑:</h5>
                    ${GAME_PARAMS.possibleCosts.map(cost => `
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="radio" name="belief" id="belief${cost}" value="${cost}">
                            <label class="form-check-label" for="belief${cost}">
                                ${cost} –º–æ–Ω–µ—Ç
                            </label>
                        </div>
                    `).join('')}
                </div>

                <button class="btn btn-primary btn-lg w-100" onclick="submitBelief()">–î–∞–ª–µ–µ</button>
            `;
        }

        function submitBelief() {
            const selected = document.querySelector('input[name="belief"]:checked');
            if (!selected) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à –ø—Ä–æ–≥–Ω–æ–∑');
                return;
            }

            database.ref(`rooms/${roomCode}/players/${playerId}/belief`).set(parseInt(selected.value));
        }

        // –≠–ö–†–ê–ù 4: –í–≤–æ–¥ –≤–∑–Ω–æ—Å–∞
        function showContributionScreen(roomData) {
            const playerBelief = roomData.players[playerId].belief;
            const container = document.getElementById('gameContainer');
            
            container.innerHTML = `
                <h2 class="text-center mb-4">–†–∞—É–Ω–¥ ${roomData.currentRound} –∏–∑ ${GAME_PARAMS.numRounds}</h2>
                
                <div class="alert alert-success">
                    –í–∞—à –ø—Ä–æ–≥–Ω–æ–∑: <strong>${playerBelief} –º–æ–Ω–µ—Ç</strong>
                </div>

                <div class="alert alert-info">
                    <strong>–®–∞–≥ 2:</strong> –ö–∞–∫–æ–π –≤–∑–Ω–æ—Å –≤—ã –≥–æ—Ç–æ–≤—ã —Å–¥–µ–ª–∞—Ç—å?
                </div>

                <div class="slider-container">
                    <label class="form-label">–í–∞—à –≤–∑–Ω–æ—Å:</label>
                    <div class="text-center contribution-value mb-3">
                        <span id="contributionDisplay">50</span> –º–æ–Ω–µ—Ç
                    </div>
                    <input type="range" class="form-range" id="contributionSlider" min="0" max="100" value="50" 
                           oninput="document.getElementById('contributionDisplay').textContent = this.value">
                </div>

                <div class="alert alert-warning">
                    <small>
                        ‚Ä¢ –ï—Å–ª–∏ —Å—É–º–º–∞ –≤—Å–µ—Ö –≤–∑–Ω–æ—Å–æ–≤ ‚â• —Ä–µ–∞–ª—å–Ω—ã–µ –∏–∑–¥–µ—Ä–∂–∫–∏ ‚Üí –ø—Ä–æ–µ–∫—Ç —Å–æ–∑–¥–∞–Ω, –≤—ã –ø–æ–ª—É—á–∏—Ç–µ 50 - –≤–∞—à_–≤–∑–Ω–æ—Å<br>
                        ‚Ä¢ –ï—Å–ª–∏ —Å—É–º–º–∞ < –∏–∑–¥–µ—Ä–∂–∫–∏ ‚Üí –ø—Ä–æ–µ–∫—Ç –ø—Ä–æ–≤–∞–ª–µ–Ω, –≤—ã —Ç–µ—Ä—è–µ—Ç–µ –≤–∑–Ω–æ—Å
                    </small>
                </div>

                <button class="btn btn-primary btn-lg w-100" onclick="submitContribution()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤–∑–Ω–æ—Å</button>
            `;
        }

        function submitContribution() {
            const contribution = parseInt(document.getElementById('contributionSlider').value);
            
            database.ref(`rooms/${roomCode}/players/${playerId}`).update({
                contribution: contribution,
                ready: true
            }).then(() => {
                checkAllReady();
            });
        }

        // –≠–ö–†–ê–ù 5: –û–∂–∏–¥–∞–Ω–∏–µ –¥—Ä—É–≥–∏—Ö
        function showWaitingScreen(roomData) {
            const players = roomData.players || {};
            const readyCount = Object.values(players).filter(p => p.ready).length;
            const totalPlayers = Object.keys(players).length;

            const container = document.getElementById('gameContainer');
            container.innerHTML = `
                <h2 class="text-center mb-4">–†–∞—É–Ω–¥ ${roomData.currentRound} –∏–∑ ${GAME_PARAMS.numRounds}</h2>
                
                <div class="text-center mb-4">
                    <div class="waiting-spinner mb-3" style="width: 60px; height: 60px; border-width: 6px;"></div>
                    <h4>–í–∞—à–∏ —Ä–µ—à–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã. –ñ–¥–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã—Ö.</h4>
                </div>

                <div class="progress mb-3" style="height: 30px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" 
                         style="width: ${(readyCount/totalPlayers)*100}%">
                        ${readyCount}/${totalPlayers} –∏–≥—Ä–æ–∫–æ–≤ –≥–æ—Ç–æ–≤—ã
                    </div>
                </div>

                <div class="alert alert-info">
                    üí° –ö–æ–≥–¥–∞ –≤—Å–µ –∏–≥—Ä–æ–∫–∏ —Å–¥–µ–ª–∞—é—Ç —Å–≤–æ–π –≤—ã–±–æ—Ä, –º—ã –ø–æ–∫–∞–∂–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—É–Ω–¥–∞.
                </div>
            `;
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤
        function checkAllReady() {
            currentRoomRef.once('value', snapshot => {
                const roomData = snapshot.val();
                const players = roomData.players || {};
                const allReady = Object.values(players).every(p => p.ready);
                const playerCount = Object.keys(players).length;

                console.log('Check ready:', Object.values(players).filter(p => p.ready).length, '/', playerCount);

                if (allReady && playerCount > 0 && !roomData.roundResults) {
                    calculateRoundResults();
                }
            });
        }

        // –†–∞—Å—á–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ä–∞—É–Ω–¥–∞ (–ª—é–±–æ–π –∏–≥—Ä–æ–∫ –º–æ–∂–µ—Ç –∑–∞–ø—É—Å—Ç–∏—Ç—å)
        function calculateRoundResults() {
            const roundResultsRef = database.ref(`rooms/${roomCode}/roundResults`);
            
            roundResultsRef.transaction(current => {
                if (current) return; // –£–∂–µ –ø–æ—Å—á–∏—Ç–∞–Ω–æ
                return true;
            }, (error, committed, snapshot) => {
                if (committed && snapshot.val() === true) {
                    console.log('Calculating results...');
                    
                    currentRoomRef.once('value', snap => {
                        const roomData = snap.val();
                        const players = roomData.players;
                        const currentRound = roomData.currentRound;

                        // –°–ª—É—á–∞–π–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å
                        const actualCost = GAME_PARAMS.possibleCosts[
                            Math.floor(Math.random() * GAME_PARAMS.possibleCosts.length)
                        ];

                        // –°—É–º–º–∏—Ä—É–µ–º –≤–∑–Ω–æ—Å—ã
                        let totalContributions = 0;
                        const contributions = {};
                        Object.entries(players).forEach(([pid, p]) => {
                            contributions[pid] = p.contribution || 0;
                            totalContributions += contributions[pid];
                        });

                        const success = totalContributions >= actualCost;

                        // –í—ã–∏–≥—Ä—ã—à–∏
                        const updates = {};
                        Object.entries(players).forEach(([pid, p]) => {
                            const payoff = success ? (GAME_PARAMS.individualBenefit - contributions[pid]) : -contributions[pid];
                            const newScore = (p.score || 0) + payoff;
                            updates[`players/${pid}/score`] = newScore;
                            updates[`players/${pid}/roundPayoff`] = payoff;
                        });

                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                        updates[`history/round${currentRound}`] = {
                            actualCost,
                            totalContributions,
                            success,
                            contributions,
                            timestamp: Date.now()
                        };

                        updates['actualCost'] = actualCost;
                        updates['totalContributions'] = totalContributions;
                        updates['success'] = success;

                        database.ref(`rooms/${roomCode}`).update(updates).then(() => {
                            console.log('Results saved!');
                        });
                    });
                }
            });
        }

        // –≠–ö–†–ê–ù 6: –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—É–Ω–¥–∞
        function showRoundResults(roomData) {
            const players = roomData.players || {};
            const currentRound = roomData.currentRound;
            const actualCost = roomData.actualCost;
            const totalContributions = roomData.totalContributions;
            const success = roomData.success;

            const container = document.getElementById('gameContainer');
            container.innerHTML = `
                <h2 class="text-center mb-4">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—É–Ω–¥–∞ ${currentRound}</h2>
                
                <div class="text-center mb-4">
                    <span class="${success ? 'success-badge' : 'fail-badge'}">
                        ${success ? '‚úÖ –ü—Ä–æ–µ–∫—Ç —Å–æ–∑–¥–∞–Ω!' : '‚ùå –ü—Ä–æ–µ–∫—Ç –ø—Ä–æ–≤–∞–ª–µ–Ω'}
                    </span>
                </div>

                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body text-center">
                                <h6 class="text-muted">–†–µ–∞–ª—å–Ω—ã–µ –∏–∑–¥–µ—Ä–∂–∫–∏</h6>
                                <h3>${actualCost} –º–æ–Ω–µ—Ç</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body text-center">
                                <h6 class="text-muted">–°—É–º–º–∞ –≤–∑–Ω–æ—Å–æ–≤ –≥—Ä—É–ø–ø—ã</h6>
                                <h3>${totalContributions} –º–æ–Ω–µ—Ç</h3>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>–ò–≥—Ä–æ–∫</th>
                                <th>–ü—Ä–æ–≥–Ω–æ–∑</th>
                                <th>–í–∑–Ω–æ—Å</th>
                                <th>–í—ã–∏–≥—Ä—ã—à</th>
                                <th>–í—Å–µ–≥–æ</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.entries(players).map(([pid, p]) => `
                                <tr ${pid === playerId ? 'class="table-primary"' : ''}>
                                    <td>${p.name} ${pid === playerId ? '(–í—ã)' : ''}</td>
                                    <td>${p.belief || '-'}</td>
                                    <td>${p.contribution || 0}</td>
                                    <td>${p.roundPayoff >= 0 ? '+' : ''}${p.roundPayoff}</td>
                                    <td><strong>${p.score}</strong></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>

                <div class="alert alert-${players[playerId].roundPayoff >= 0 ? 'success' : 'danger'}">
                    <strong>–í–∞—à –≤—ã–∏–≥—Ä—ã—à –≤ —Ä–∞—É–Ω–¥–µ:</strong> ${players[playerId].roundPayoff} –º–æ–Ω–µ—Ç<br>
                    <strong>–ù–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–π –≤—ã–∏–≥—Ä—ã—à:</strong> ${players[playerId].score} –º–æ–Ω–µ—Ç
                </div>

                <button class="btn btn-primary btn-lg w-100" onclick="nextRound()">
                    ${currentRound < GAME_PARAMS.numRounds ? '–°–ª–µ–¥—É—é—â–∏–π —Ä–∞—É–Ω–¥' : '–§–∏–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã'}
                </button>
            `;
        }

        function nextRound() {
            currentRoomRef.once('value', snapshot => {
                const roomData = snapshot.val();
                const currentRound = roomData.currentRound;

                if (currentRound >= GAME_PARAMS.numRounds) {
                    // –ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞
                    database.ref(`rooms/${roomCode}`).update({
                        status: 'finished'
                    });
                    return;
                }

                // –°–ª–µ–¥—É—é—â–∏–π —Ä–∞—É–Ω–¥
                const updates = {
                    currentRound: currentRound + 1,
                    roundResults: null,
                    actualCost: null,
                    totalContributions: null,
                    success: null
                };

                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∏ –¥–∞–Ω–Ω—ã–µ —Ä–∞—É–Ω–¥–∞
                Object.keys(roomData.players).forEach(pid => {
                    updates[`players/${pid}/ready`] = false;
                    updates[`players/${pid}/belief`] = null;
                    updates[`players/${pid}/contribution`] = null;
                    updates[`players/${pid}/roundPayoff`] = null;
                });

                database.ref(`rooms/${roomCode}`).update(updates);
            });
        }

        // –≠–ö–†–ê–ù 7: –§–∏–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        function showFinalResults(roomData) {
            const players = roomData.players || {};
            const history = roomData.history || {};
            const sortedPlayers = Object.entries(players).sort((a, b) => b[1].score - a[1].score);
            const successCount = Object.values(history).filter(h => h.success).length;

            const container = document.getElementById('gameContainer');
            container.innerHTML = `
                <h1 class="text-center mb-4">üéâ –ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</h1>

                <div class="card mb-4">
                    <div class="card-body">
                        <h4 class="text-center">–ò—Ç–æ–≥–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞</h4>
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>–ú–µ—Å—Ç–æ</th>
                                    <th>–ò–≥—Ä–æ–∫</th>
                                    <th>–ò—Ç–æ–≥–æ–≤—ã–π —Å—á–µ—Ç</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sortedPlayers.map(([pid, p], index) => `
                                    <tr ${pid === playerId ? 'class="table-primary"' : ''}>
                                        <td><strong>${index + 1}</strong></td>
                                        <td>${p.name} ${pid === playerId ? '(–í—ã)' : ''}</td>
                                        <td><h5>${p.score} –º–æ–Ω–µ—Ç</h5></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <h6 class="text-muted">–û–±—â–∏–π –≤—ã–∏–≥—Ä—ã—à</h6>
                                <h3>${players[playerId].score} –º–æ–Ω–µ—Ç</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <h6 class="text-muted">–°—Ä–µ–¥–Ω–∏–π –≤—ã–∏–≥—Ä—ã—à –∑–∞ —Ä–∞—É–Ω–¥</h6>
                                <h3>${(players[playerId].score / GAME_PARAMS.numRounds).toFixed(1)} –º–æ–Ω–µ—Ç</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <h6 class="text-muted">–£—Å–ø–µ—à–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤</h6>
                                <h3>${successCount} –∏–∑ ${GAME_PARAMS.numRounds}</h3>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-body">
                        <h5>–ò—Å—Ç–æ—Ä–∏—è —Ä–∞—É–Ω–¥–æ–≤</h5>
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>–†–∞—É–Ω–¥</th>
                                    <th>–ü—Ä–æ–≥–Ω–æ–∑</th>
                                    <th>–í–∑–Ω–æ—Å</th>
                                    <th>–†–µ–∞–ª—å–Ω—ã–µ –∏–∑–¥–µ—Ä–∂–∫–∏</th>
                                    <th>–°—É–º–º–∞ –≥—Ä—É–ø–ø—ã</th>
                                    <th>–°—Ç–∞—Ç—É—Å</th>
                                    <th>–í—ã–∏–≥—Ä—ã—à</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.entries(history).map(([round, data]) => {
                                    const roundNum = parseInt(round.replace('round', ''));
                                    const myContribution = data.contributions[playerId] || 0;
                                    const myPayoff = data.success ? (50 - myContribution) : -myContribution;
                                    return `
                                        <tr>
                                            <td>${roundNum}</td>
                                            <td>-</td>
                                            <td>${myContribution}</td>
                                            <td>${data.actualCost}</td>
                                            <td>${data.totalContributions}</td>
                                            <td>${data.success ? '‚úÖ' : '‚ùå'}</td>
                                            <td>${myPayoff >= 0 ? '+' : ''}${myPayoff}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="d-grid gap-2">
                    <button class="btn btn-primary btn-lg" onclick="downloadCSV()">–°–∫–∞—á–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã (CSV)</button>
                    <button class="btn btn-outline-secondary" onclick="playAgain()">–ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞</button>
                </div>
            `;
        }

        function downloadCSV() {
            currentRoomRef.once('value', snapshot => {
                const roomData = snapshot.val();
                const players = roomData.players;
                const history = roomData.history || {};

                let csv = 'RoomCode,PlayerId,PlayerName,Round,Belief,Contribution,ActualCost,TotalContributions,Success,RoundPayoff,TotalScore\n';

                Object.entries(history).forEach(([roundKey, data]) => {
                    const roundNum = parseInt(roundKey.replace('round', ''));
                    Object.entries(players).forEach(([pid, p]) => {
                        const contrib = data.contributions[pid] || 0;
                        const payoff = data.success ? (50 - contrib) : -contrib;
                        csv += `${roomCode},${pid},${p.name},${roundNum},-,${contrib},${data.actualCost},${data.totalContributions},${data.success},${payoff},${p.score}\n`;
                    });
                });

                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `results_${roomCode}_${Date.now()}.csv`;
                a.click();
            });
        }

        function playAgain() {
            if (currentRoomRef) {
                currentRoomRef.off();
            }
            showHomeScreen();
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        showHomeScreen();
    </script>
</body>
</html>
