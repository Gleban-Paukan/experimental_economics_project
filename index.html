<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–∏–ª–µ–º–º–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∏–∑–¥–µ—Ä–∂–µ–∫ - Multiplayer</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            /* Primitive Color Tokens */
            --color-white: rgba(255, 255, 255, 1);
            --color-black: rgba(0, 0, 0, 1);
            --color-cream-50: rgba(252, 252, 249, 1);
            --color-cream-100: rgba(255, 255, 253, 1);
            --color-gray-200: rgba(245, 245, 245, 1);
            --color-gray-300: rgba(167, 169, 169, 1);
            --color-gray-400: rgba(119, 124, 124, 1);
            --color-slate-500: rgba(98, 108, 113, 1);
            --color-brown-600: rgba(94, 82, 64, 1);
            --color-charcoal-700: rgba(31, 33, 33, 1);
            --color-charcoal-800: rgba(38, 40, 40, 1);
            --color-slate-900: rgba(19, 52, 59, 1);
            --color-teal-300: rgba(50, 184, 198, 1);
            --color-teal-400: rgba(45, 166, 178, 1);
            --color-teal-500: rgba(33, 128, 141, 1);
            --color-teal-600: rgba(29, 116, 128, 1);
            --color-teal-700: rgba(26, 104, 115, 1);
            --color-teal-800: rgba(41, 150, 161, 1);
            --color-red-400: rgba(255, 84, 89, 1);
            --color-red-500: rgba(192, 21, 47, 1);
            --color-orange-400: rgba(230, 129, 97, 1);
            --color-orange-500: rgba(168, 75, 47, 1);

            /* RGB versions for opacity control */
            --color-brown-600-rgb: 94, 82, 64;
            --color-teal-500-rgb: 33, 128, 141;
            --color-slate-900-rgb: 19, 52, 59;
            --color-slate-500-rgb: 98, 108, 113;
            --color-red-500-rgb: 192, 21, 47;
            --color-red-400-rgb: 255, 84, 89;
            --color-orange-500-rgb: 168, 75, 47;
            --color-orange-400-rgb: 230, 129, 97;

            /* Background color tokens (Light Mode) */
            --color-bg-1: rgba(59, 130, 246, 0.08);
            --color-bg-2: rgba(245, 158, 11, 0.08);
            --color-bg-3: rgba(34, 197, 94, 0.08);
            --color-bg-4: rgba(239, 68, 68, 0.08);
            --color-bg-5: rgba(147, 51, 234, 0.08);
            --color-bg-6: rgba(249, 115, 22, 0.08);
            --color-bg-7: rgba(236, 72, 153, 0.08);
            --color-bg-8: rgba(6, 182, 212, 0.08);

            /* Semantic Color Tokens (Light Mode) */
            --color-background: var(--color-cream-50);
            --color-surface: var(--color-cream-100);
            --color-text: var(--color-slate-900);
            --color-text-secondary: var(--color-slate-500);
            --color-primary: var(--color-teal-500);
            --color-primary-hover: var(--color-teal-600);
            --color-primary-active: var(--color-teal-700);
            --color-secondary: rgba(var(--color-brown-600-rgb), 0.12);
            --color-secondary-hover: rgba(var(--color-brown-600-rgb), 0.2);
            --color-secondary-active: rgba(var(--color-brown-600-rgb), 0.25);
            --color-border: rgba(var(--color-brown-600-rgb), 0.2);
            --color-btn-primary-text: var(--color-cream-50);
            --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);
            --color-card-border-inner: rgba(var(--color-brown-600-rgb), 0.12);
            --color-error: var(--color-red-500);
            --color-success: var(--color-teal-500);
            --color-warning: var(--color-orange-500);
            --color-info: var(--color-slate-500);
            --color-focus-ring: rgba(var(--color-teal-500-rgb), 0.4);
            --color-select-caret: rgba(var(--color-slate-900-rgb), 0.8);

            /* Common style patterns */
            --focus-ring: 0 0 0 3px var(--color-focus-ring);
            --focus-outline: 2px solid var(--color-primary);
            --status-bg-opacity: 0.15;
            --status-border-opacity: 0.25;

            /* Typography */
            --font-family-base: "Geist", "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            --font-family-mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
            --font-size-xs: 11px;
            --font-size-sm: 12px;
            --font-size-base: 14px;
            --font-size-md: 14px;
            --font-size-lg: 16px;
            --font-size-xl: 18px;
            --font-size-2xl: 20px;
            --font-size-3xl: 24px;
            --font-size-4xl: 30px;
            --font-weight-normal: 400;
            --font-weight-medium: 500;
            --font-weight-semibold: 550;
            --font-weight-bold: 600;
            --line-height-tight: 1.2;
            --line-height-normal: 1.5;
            --letter-spacing-tight: -0.01em;

            /* Spacing */
            --space-0: 0;
            --space-1: 1px;
            --space-2: 2px;
            --space-4: 4px;
            --space-6: 6px;
            --space-8: 8px;
            --space-10: 10px;
            --space-12: 12px;
            --space-16: 16px;
            --space-20: 20px;
            --space-24: 24px;
            --space-32: 32px;

            /* Border Radius */
            --radius-sm: 6px;
            --radius-base: 8px;
            --radius-md: 10px;
            --radius-lg: 12px;
            --radius-full: 9999px;

            /* Shadows */
            --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.02);
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.04), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.04), 0 4px 6px -2px rgba(0, 0, 0, 0.02);
            --shadow-inset-sm: inset 0 1px 0 rgba(255, 255, 255, 0.15), inset 0 -1px 0 rgba(0, 0, 0, 0.03);

            /* Animation */
            --duration-fast: 150ms;
            --duration-normal: 250ms;
            --ease-standard: cubic-bezier(0.16, 1, 0.3, 1);
        }

        /* Base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            font-size: var(--font-size-base);
            font-family: var(--font-family-base);
            line-height: var(--line-height-normal);
            color: var(--color-text);
            background-color: var(--color-background);
            -webkit-font-smoothing: antialiased;
        }

        body {
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: var(--space-20);
        }

        .screen {
            display: none;
            opacity: 0;
            transform: translateY(20px);
            transition: all var(--duration-normal) var(--ease-standard);
        }

        .screen.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        .card {
            background-color: var(--color-surface);
            border-radius: var(--radius-lg);
            border: 1px solid var(--color-card-border);
            box-shadow: var(--shadow-sm);
            padding: var(--space-24);
            margin-bottom: var(--space-16);
        }

        .card h1, .card h2, .card h3 {
            margin-bottom: var(--space-16);
            color: var(--color-text);
            font-weight: var(--font-weight-semibold);
        }

        .card h1 {
            font-size: var(--font-size-3xl);
            text-align: center;
        }

        .card h2 {
            font-size: var(--font-size-2xl);
        }

        .card h3 {
            font-size: var(--font-size-xl);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: var(--space-12) var(--space-20);
            border-radius: var(--radius-base);
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-medium);
            cursor: pointer;
            transition: all var(--duration-normal) var(--ease-standard);
            border: none;
            text-decoration: none;
            min-width: 120px;
        }

        .btn--primary {
            background: var(--color-primary);
            color: var(--color-btn-primary-text);
        }

        .btn--primary:hover {
            background: var(--color-primary-hover);
        }

        .btn--primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn--secondary {
            background: var(--color-secondary);
            color: var(--color-text);
        }

        .btn--secondary:hover {
            background: var(--color-secondary-hover);
        }

        .form-control {
            display: block;
            width: 100%;
            padding: var(--space-12);
            font-size: var(--font-size-base);
            line-height: 1.5;
            color: var(--color-text);
            background-color: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            margin-bottom: var(--space-16);
        }

        .form-control:focus {
            border-color: var(--color-primary);
            outline: var(--focus-outline);
        }

        .form-group {
            margin-bottom: var(--space-16);
        }

        .form-label {
            display: block;
            margin-bottom: var(--space-8);
            font-weight: var(--font-weight-medium);
        }

        .radio-group {
            display: flex;
            flex-direction: column;
            gap: var(--space-8);
            margin-bottom: var(--space-16);
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: var(--space-8);
            padding: var(--space-8);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            cursor: pointer;
            transition: all var(--duration-fast) var(--ease-standard);
        }

        .radio-option:hover {
            background-color: var(--color-secondary);
        }

        .radio-option.selected {
            background-color: var(--color-bg-3);
            border-color: var(--color-success);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: var(--color-secondary);
            border-radius: var(--radius-full);
            overflow: hidden;
            margin-bottom: var(--space-20);
        }

        .progress-fill {
            height: 100%;
            background-color: var(--color-primary);
            transition: width var(--duration-normal) var(--ease-standard);
        }

        .slider-container {
            margin: var(--space-16) 0;
        }

        .slider {
            width: 100%;
            height: 6px;
            border-radius: var(--radius-full);
            background: var(--color-secondary);
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--color-primary);
            cursor: pointer;
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--color-primary);
            cursor: pointer;
            border: none;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: var(--space-16);
        }

        .table th,
        .table td {
            padding: var(--space-8) var(--space-12);
            text-align: left;
            border-bottom: 1px solid var(--color-border);
        }

        .table th {
            background-color: var(--color-secondary);
            font-weight: var(--font-weight-semibold);
        }

        .status {
            display: inline-flex;
            align-items: center;
            padding: var(--space-4) var(--space-8);
            border-radius: var(--radius-full);
            font-weight: var(--font-weight-medium);
            font-size: var(--font-size-sm);
        }

        .status--success {
            background-color: rgba(var(--color-teal-500-rgb), var(--status-bg-opacity));
            color: var(--color-success);
            border: 1px solid rgba(var(--color-teal-500-rgb), var(--status-border-opacity));
        }

        .status--error {
            background-color: rgba(var(--color-red-500-rgb), var(--status-bg-opacity));
            color: var(--color-error);
            border: 1px solid rgba(var(--color-red-500-rgb), var(--status-border-opacity));
        }

        .grid {
            display: grid;
            gap: var(--space-16);
        }

        .grid-2 {
            grid-template-columns: 1fr 1fr;
        }

        .text-center {
            text-align: center;
        }

        .text-large {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-medium);
        }

        .mb-16 {
            margin-bottom: var(--space-16);
        }

        .mb-8 {
            margin-bottom: var(--space-8);
        }

        .error-message {
            color: var(--color-error);
            font-size: var(--font-size-sm);
            margin-top: var(--space-4);
        }

        .highlight {
            background-color: var(--color-bg-2);
            padding: var(--space-16);
            border-radius: var(--radius-base);
            margin: var(--space-16) 0;
        }
        
        .copy-hint {
            font-size: var(--font-size-xs);
            color: var(--color-text-secondary);
            opacity: 0.7;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid var(--color-secondary);
            border-radius: 50%;
            border-top-color: var(--color-primary);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .player-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-8);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            margin-bottom: var(--space-8);
            transition: background-color var(--duration-fast) var(--ease-standard);
        }
        
        .player-status.current-player {
            font-weight: var(--font-weight-bold);
            background-color: var(--color-bg-1);
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: var(--space-4);
        }

        .contribution-display {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-bold);
            color: var(--color-primary);
            text-align: center;
            margin: var(--space-16) 0;
        }

        .chart-container {
            height: 300px;
            margin: var(--space-20) 0;
        }

        @media (max-width: 768px) {
            .container {
                padding: var(--space-16);
            }
            
            .card {
                padding: var(--space-16);
            }
            
            .grid-2 {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –°—Ç–∞—Ä—Ç–æ–≤—ã–π —ç–∫—Ä–∞–Ω -->
        <div id="start-screen" class="screen active">
            <div class="card">
                <h1>üéØ –î–∏–ª–µ–º–º–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∏–∑–¥–µ—Ä–∂–µ–∫</h1>
                <p class="text-center mb-16">–ú–Ω–æ–≥–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–π —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç</p>
                
                <div class="form-group">
                    <label class="form-label" for="player-name">–í–∞—à–µ –∏–º—è:</label>
                    <input type="text" id="player-name" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è">
                    <div id="name-error" class="error-message" style="display: none;"></div>
                </div>
                
                <div class="grid grid-2">
                    <button class="btn btn--primary" onclick="createRoom()">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
                    <button class="btn btn--secondary" onclick="showJoinRoom()">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
                </div>
                
                <div id="join-room-section" style="display: none; margin-top: 16px;">
                    <div class="form-group">
                        <label class="form-label" for="room-code">–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã:</label>
                        <input type="text" id="room-code" class="form-control" placeholder="ABC123" maxlength="6">
                    </div>
                    <button class="btn btn--primary btn--full-width" onclick="joinRoom()">–í–æ–π—Ç–∏ –≤ –∫–æ–º–Ω–∞—Ç—É</button>
                </div>
                
                <div class="highlight">
                    <h3>üìã –ö—Ä–∞—Ç–∫–∏–µ –ø—Ä–∞–≤–∏–ª–∞:</h3>
                    <ul style="margin-left: 20px;">
                        <li>4 –∏–≥—Ä–æ–∫–∞ —Å–æ–∑–¥–∞—é—Ç –æ–±—â–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –±–ª–∞–≥–æ</li>
                        <li>–ò–∑–¥–µ—Ä–∂–∫–∏ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã: 60, 80, 100, 120 –∏–ª–∏ 140</li>
                        <li>–ï—Å–ª–∏ —Å—É–º–º–∞ –≤–∑–Ω–æ—Å–æ–≤ ‚â• –∏–∑–¥–µ—Ä–∂–µ–∫ ‚Üí –ø—Ä–æ–µ–∫—Ç —Å–æ–∑–¥–∞–Ω</li>
                        <li>–í—ã–∏–≥—Ä—ã—à: 50 - –≤–∞—à –≤–∑–Ω–æ—Å (–µ—Å–ª–∏ —Å–æ–∑–¥–∞–Ω) –∏–ª–∏ -–≤–∞—à –≤–∑–Ω–æ—Å (–µ—Å–ª–∏ –ø—Ä–æ–≤–∞–ª–µ–Ω)</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- –õ–æ–±–±–∏ -->
        <div id="lobby-screen" class="screen">
            <div class="card">
                <h2>üè† –ö–æ–º–Ω–∞—Ç–∞ <span id="lobby-room-code"></span></h2>
                <p class="text-center mb-16">–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å –∫–æ–¥–æ–º —Å –¥—Ä—É–∑—å—è–º–∏</p>
                
                <div class="highlight text-center" style="margin-bottom: 24px;">
                    <h3 id="room-code-display" style="font-size: 32px; letter-spacing: 4px; cursor: pointer;" onclick="copyRoomCode()"></h3>
                    <p style="font-size: 12px; color: var(--color-text-secondary);">–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</p>
                </div>
                
                <div class="form-group">
                    <h3>üë• –ò–≥—Ä–æ–∫–∏ –≤ –∫–æ–º–Ω–∞—Ç–µ (<span id="player-count">1</span>/4):</h3>
                    <div id="players-list"></div>
                </div>
                
                <div class="text-center">
                    <p class="mb-8">–ò–≥—Ä–æ–∫–æ–≤ –≥–æ—Ç–æ–≤–æ: <span id="ready-count">0</span>/4</p>
                    <button id="ready-btn" class="btn btn--primary" onclick="toggleReady()">–Ø –≥–æ—Ç–æ–≤!</button>
                    <button class="btn btn--secondary" onclick="leaveRoom()" style="margin-left: 16px;">–ü–æ–∫–∏–Ω—É—Ç—å</button>
                </div>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π -->
        <div id="instructions-screen" class="screen">
            <div class="card">
                <h2>üìã –ü—Ä–∞–≤–∏–ª–∞ –∏–≥—Ä—ã</h2>
                
                <div class="highlight">
                    <h3>–ù–∞—á–∞–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è:</h3>
                    <ul style="margin-left: 20px; margin-bottom: 16px;">
                        <li>–£ –∫–∞–∂–¥–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞ –µ—Å—Ç—å <strong>100 –º–æ–Ω–µ—Ç</strong></li>
                        <li>–ì—Ä—É–ø–ø–∞ –∏–∑ <strong>4 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</strong> –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å –æ–±—â–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –±–ª–∞–≥–æ</li>
                        <li>–≠—Ç–æ –±–ª–∞–≥–æ –±—É–¥–µ—Ç –ø–æ—Ä–æ–≤–Ω—É —Ä–∞–∑–¥–µ–ª–µ–Ω–æ –º–µ–∂–¥—É –≤—Å–µ–º–∏ (<strong>–ø–æ 50 –º–æ–Ω–µ—Ç –∫–∞–∂–¥–æ–º—É</strong>)</li>
                    </ul>
                </div>

                <div class="highlight">
                    <h3>üé≤ –ù–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ—Å—Ç—å:</h3>
                    <ul style="margin-left: 20px; margin-bottom: 16px;">
                        <li>–†–µ–∞–ª—å–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å —Å–æ–∑–¥–∞–Ω–∏—è –±–ª–∞–≥–∞ <strong>–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞ –∑–∞—Ä–∞–Ω–µ–µ</strong></li>
                        <li>–û–Ω–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å: <strong>60, 80, 100, 120 –∏–ª–∏ 140 –º–æ–Ω–µ—Ç</strong></li>
                        <li>–°—Ç–æ–∏–º–æ—Å—Ç—å –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è <strong>—Å–ª—É—á–∞–π–Ω–æ –≤ –∫–∞–∂–¥–æ–º —Ä–∞—É–Ω–¥–µ</strong></li>
                    </ul>
                </div>

                <div class="highlight">
                    <h3>‚öôÔ∏è –ú–µ—Ö–∞–Ω–∏–∑–º:</h3>
                    <ul style="margin-left: 20px; margin-bottom: 16px;">
                        <li>–ö–∞–∂–¥—ã–π —É—á–∞—Å—Ç–Ω–∏–∫ –¥–µ–ª–∞–µ—Ç –≤–∑–Ω–æ—Å (–æ—Ç 0 –¥–æ 100)</li>
                        <li>–ï—Å–ª–∏ <strong>—Å—É–º–º–∞ –≤—Å–µ—Ö –≤–∑–Ω–æ—Å–æ–≤ ‚â• —Ä–µ–∞–ª—å–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</strong> ‚Üí –ø—Ä–æ–µ–∫—Ç <span class="status status--success">–°–û–ó–î–ê–ù</span></li>
                        <li>–ï—Å–ª–∏ <strong>—Å—É–º–º–∞ &lt; —Å—Ç–æ–∏–º–æ—Å—Ç—å</strong> ‚Üí –ø—Ä–æ–µ–∫—Ç <span class="status status--error">–ü–†–û–í–ê–õ–ï–ù</span>, –≤–∑–Ω–æ—Å—ã –ø–æ—Ç–µ—Ä—è–Ω—ã</li>
                    </ul>
                </div>

                <div class="highlight">
                    <h3>üí∞ –†–∞—Å—á–µ—Ç –≤—ã–∏–≥—Ä—ã—à–∞:</h3>
                    <ul style="margin-left: 20px; margin-bottom: 16px;">
                        <li><strong>–ü—Ä–æ–µ–∫—Ç —Å–æ–∑–¥–∞–Ω:</strong> –≤—ã–∏–≥—Ä—ã—à = 50 - –≤–∞—à –≤–∑–Ω–æ—Å</li>
                        <li><strong>–ü—Ä–æ–µ–∫—Ç –ø—Ä–æ–≤–∞–ª–µ–Ω:</strong> –≤—ã–∏–≥—Ä—ã—à = -–≤–∞—à –≤–∑–Ω–æ—Å</li>
                    </ul>
                </div>

                <p class="text-center"><strong>üéØ –¶–ï–õ–¨: –ú–∞–∫—Å–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–≤–æ–π –æ–±—â–∏–π –≤—ã–∏–≥—Ä—ã—à –∑–∞ 5 —Ä–∞—É–Ω–¥–æ–≤</strong></p>
            </div>

            <div class="card">
                <h3>‚ùì –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã</h3>
                <p>–û—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å:</p>
                
                <div id="quiz-questions"></div>
                
                <div id="quiz-error" class="error-message" style="display: none;"></div>
                
                <div class="text-center">
                    <button class="btn btn--primary" onclick="checkQuiz()">–Ø –ø–æ–Ω—è–ª –ø—Ä–∞–≤–∏–ª–∞, –Ω–∞—á–∞—Ç—å —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç</button>
                </div>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω —Ä–∞—É–Ω–¥–∞ -->
        <div id="round-screen" class="screen">
            <div class="progress-bar">
                <div id="progress-fill" class="progress-fill" style="width: 0%"></div>
            </div>
            
            <div class="card">
                <h2 id="round-title">–†–∞—É–Ω–¥ 1 –∏–∑ 5</h2>
                
                <div class="grid grid-2">
                    <div>
                        <h3>üë• –°—Ç–∞—Ç—É—Å –∏–≥—Ä–æ–∫–æ–≤:</h3>
                        <div id="players-status"></div>
                    </div>
                    <div>
                        <h3>üìä –û—á–∫–∏:</h3>
                        <div id="scores-display"></div>
                    </div>
                </div>
                
                <div id="history-section" style="display: none;">
                    <h3>üìä –ò—Å—Ç–æ—Ä–∏—è –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Ä–∞—É–Ω–¥–æ–≤</h3>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>–†–∞—É–Ω–¥</th>
                                <th>–í–∞—à –ø—Ä–æ–≥–Ω–æ–∑</th>
                                <th>–í–∞—à –≤–∑–Ω–æ—Å</th>
                                <th>–†–µ–∞–ª—å–Ω—ã–µ –∏–∑–¥–µ—Ä–∂–∫–∏</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>–í—ã–∏–≥—Ä—ã—à</th>
                            </tr>
                        </thead>
                        <tbody id="history-table"></tbody>
                    </table>
                </div>
            </div>

            <div class="card">
                <h3>üîÆ –®–∞–≥ 1: –í–∞—à –ø—Ä–æ–≥–Ω–æ–∑</h3>
                <p class="mb-16">–ö–∞–∫ –≤—ã –¥—É–º–∞–µ—Ç–µ, –∫–∞–∫–∏–º–∏ –±—É–¥—É—Ç —Ä–µ–∞–ª—å–Ω—ã–µ –∏–∑–¥–µ—Ä–∂–∫–∏ –≤ —ç—Ç–æ–º —Ä–∞—É–Ω–¥–µ?</p>
                
                <div id="expectation-options" class="radio-group"></div>
                
                <div id="step1-error" class="error-message" style="display: none;"></div>
            </div>

            <div id="contribution-section" class="card" style="display: none;">
                <h3>üí∞ –®–∞–≥ 2: –í–∞—à –≤–∑–Ω–æ—Å</h3>
                <p class="mb-16">–í–∞—à –ø—Ä–æ–≥–Ω–æ–∑: <span id="selected-expectation" class="text-large"></span> –º–æ–Ω–µ—Ç</p>
                
                <div class="highlight">
                    <p><strong>üí° –ü–æ–¥—Å–∫–∞–∑–∫–∞:</strong> –ü—Ä–æ–µ–∫—Ç —Å–æ–∑–¥–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å—É–º–º–∞ –≤—Å–µ—Ö –≤–∑–Ω–æ—Å–æ–≤ ‚â• —Ä–µ–∞–ª—å–Ω—ã–º –∏–∑–¥–µ—Ä–∂–∫–∞–º. 
                    –ï—Å–ª–∏ –ø—Ä–æ–µ–∫—Ç —Å–æ–∑–¥–∞–Ω, –≤—ã –ø–æ–ª—É—á–∏—Ç–µ 50 –º–æ–Ω–µ—Ç –º–∏–Ω—É—Å –≤–∞—à –≤–∑–Ω–æ—Å. –ï—Å–ª–∏ –ø—Ä–æ–≤–∞–ª–µ–Ω - –ø–æ—Ç–µ—Ä—è–µ—Ç–µ –≤–µ—Å—å –≤–∑–Ω–æ—Å.</p>
                </div>
                
                <div class="form-group">
                    <label class="form-label">–í–∞—à –≤–∑–Ω–æ—Å (0-100 –º–æ–Ω–µ—Ç):</label>
                    <div class="slider-container">
                        <input type="range" id="contribution-slider" class="slider" min="0" max="100" value="25">
                        <div class="contribution-display" id="contribution-value">25 –º–æ–Ω–µ—Ç</div>
                    </div>
                </div>
                
                <div class="text-center">
                    <button class="btn btn--primary" onclick="submitRound()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —Ä–µ—à–µ–Ω–∏–µ</button>
                </div>
            </div>
        </div>
        
        <!-- –≠–∫—Ä–∞–Ω –æ–∂–∏–¥–∞–Ω–∏—è -->
        <div id="waiting-screen" class="screen">
            <div class="card text-center">
                <h2>‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –¥—Ä—É–≥–∏—Ö –∏–≥—Ä–æ–∫–æ–≤...</h2>
                <p class="mb-16">–í–∞—à–∏ —Ä–µ—à–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã. –ñ–¥–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã—Ö.</p>
                
                <div id="waiting-status"></div>
                
                <div class="highlight">
                    <p>üí° –ö–æ–≥–¥–∞ –≤—Å–µ –∏–≥—Ä–æ–∫–∏ —Å–¥–µ–ª–∞—é—Ç —Å–≤–æ–π –≤—ã–±–æ—Ä, –º—ã –ø–æ–∫–∞–∂–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—É–Ω–¥–∞.</p>
                </div>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ä–∞—É–Ω–¥–∞ -->
        <div id="results-screen" class="screen">
            <div class="card">
                <h2 id="results-title">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—É–Ω–¥–∞ 1</h2>
                
                <div class="grid grid-2">
                    <div>
                        <h3>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≥—Ä—É–ø–ø—ã</h3>
                        <table class="table">
                            <tbody id="round-results-table"></tbody>
                        </table>
                    </div>
                    
                    <div>
                        <h3>üí∞ –í–∞—à–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</h3>
                        <div class="highlight">
                            <p><strong>–°—Ç–∞—Ç—É—Å –ø—Ä–æ–µ–∫—Ç–∞:</strong> <span id="project-status"></span></p>
                            <p><strong>–í–∞—à –≤—ã–∏–≥—Ä—ã—à –≤ —Ä–∞—É–Ω–¥–µ:</strong> <span id="round-payoff" class="text-large"></span> –º–æ–Ω–µ—Ç</p>
                            <p><strong>–ù–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–π –≤—ã–∏–≥—Ä—ã—à:</strong> <span id="total-payoff" class="text-large"></span> –º–æ–Ω–µ—Ç</p>
                        </div>
                    </div>
                </div>
                
                <div class="text-center">
                    <button id="next-round-btn" class="btn btn--primary" onclick="nextRound()">–°–ª–µ–¥—É—é—â–∏–π —Ä–∞—É–Ω–¥</button>
                </div>
            </div>
        </div>

        <!-- –§–∏–Ω–∞–ª—å–Ω—ã–π —ç–∫—Ä–∞–Ω -->
        <div id="final-screen" class="screen">
            <div class="card">
                <h1>üéâ –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç –∑–∞–≤–µ—Ä—à–µ–Ω!</h1>
                
                <div class="grid grid-2">
                    <div>
                        <h3>üìà –í–∞—à–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</h3>
                        <div class="highlight">
                            <p class="text-large"><strong>–û–±—â–∏–π –≤—ã–∏–≥—Ä—ã—à:</strong> <span id="final-total-payoff"></span> –º–æ–Ω–µ—Ç</p>
                            <p><strong>–°—Ä–µ–¥–Ω–∏–π –≤—ã–∏–≥—Ä—ã—à –∑–∞ —Ä–∞—É–Ω–¥:</strong> <span id="average-payoff"></span> –º–æ–Ω–µ—Ç</p>
                            <p><strong>–£—Å–ø–µ—à–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤:</strong> <span id="successful-projects"></span> –∏–∑ 5</p>
                        </div>
                    </div>
                    
                    <div>
                        <h3>üìä –ì—Ä–∞—Ñ–∏–∫ –≤–∞—à–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</h3>
                        <div class="chart-container">
                            <canvas id="payoff-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>üìã –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                <table class="table">
                    <thead>
                        <tr>
                            <th>–†–∞—É–Ω–¥</th>
                            <th>–ü—Ä–æ–≥–Ω–æ–∑</th>
                            <th>–í–∑–Ω–æ—Å</th>
                            <th>–†–µ–∞–ª—å–Ω—ã–µ –∏–∑–¥–µ—Ä–∂–∫–∏</th>
                            <th>–°—É–º–º–∞ –≥—Ä—É–ø–ø—ã</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–í—ã–∏–≥—Ä—ã—à</th>
                        </tr>
                    </thead>
                    <tbody id="final-results-table"></tbody>
                </table>
            </div>
            
            <div class="card text-center">
                <button class="btn btn--primary" onclick="downloadResults()" style="margin-right: 16px;">üìÅ –°–∫–∞—á–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã CSV</button>
                <button class="btn btn--secondary" onclick="restartGame()">üîÑ –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</button>
            </div>
        </div>
    </div>

    <script>
        // –í–ê–ñ–ù–û! –ó–ê–ú–ï–ù–ò–¢–ï –≠–¢–û –°–í–û–ï–ô –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ï–ô –ò–ó FIREBASE CONSOLE
        const firebaseConfig = {
            apiKey: "AIzaSyBdqtRnPhfqgYJYSMR5TZucmVHTuE4WTY8",
            authDomain: "cost-sharing-game.firebaseapp.com",
            databaseURL: "https://cost-sharing-game-default-rtdb.firebaseio.com",
            projectId: "cost-sharing-game",
            storageBucket: "cost-sharing-game.firebasestorage.app",
            messagingSenderId: "882128282715",
            appId: "1:882128282715:web:2fc86b8c68cbf3ccc44b7e"
          };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        let app, database;
        try {
            app = firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            console.log('Firebase initialized successfully');
        } catch (error) {
            console.error('Firebase initialization failed:', error);
            alert('Firebase –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –≤ –∫–æ–¥–µ.');
        }

        // –ò–≥—Ä–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        const gameState = {
            playerId: null,
            playerName: '',
            roomCode: '',
            isHost: false,
            currentRound: 1,
            possibleCosts: [60, 80, 100, 120, 140],
            roomRef: null,
            playersRef: null,
            gameHistory: [],
            currentScreen: 'start-screen'
        };

        // –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Firebase
        function generateRoomCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let result = '';
            for (let i = 0; i < 6; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        function generatePlayerId() {
            return Date.now().toString() + Math.random().toString(36).substr(2, 9);
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å Firebase
        function checkFirebaseConnection() {
            if (!database) {
                showError('Firebase –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é.');
                return false;
            }
            return true;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä—ã
        function initGame() {
            gameState.playerId = generatePlayerId();
            showScreen('start-screen');
            setupSlider();
            setupPresence();
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ presence —Å–∏—Å—Ç–µ–º—ã
        function setupPresence() {
            if (!database) return;
            
            // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
            const connectedRef = database.ref('.info/connected');
            connectedRef.on('value', (snap) => {
                if (snap.val() === true) {
                    console.log('Connected to Firebase');
                } else {
                    console.log('Disconnected from Firebase');
                }
            });
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —ç–∫—Ä–∞–Ω–æ–≤
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
            gameState.currentScreen = screenId;
        }

        function showError(message, elementId = null) {
            if (elementId) {
                const errorDiv = document.getElementById(elementId);
                if (errorDiv) {
                    errorDiv.textContent = message;
                    errorDiv.style.display = 'block';
                }
            } else {
                alert(message);
            }
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã
        function createRoom() {
            const playerName = document.getElementById('player-name').value.trim();
            if (!playerName) {
                showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è', 'name-error');
                return;
            }
            
            if (!checkFirebaseConnection()) return;
            
            gameState.playerName = playerName;
            gameState.roomCode = generateRoomCode();
            gameState.isHost = true;
            
            // –°–æ–∑–¥–∞–µ–º –∫–æ–º–Ω–∞—Ç—É –≤ Firebase
            const roomData = {
                status: 'waiting',
                currentRound: 1,
                roundStartTime: 0,
                actualCost: 0,
                host: gameState.playerId,
                players: {
                    [gameState.playerId]: {
                        id: gameState.playerId,
                        name: playerName,
                        belief: 0,
                        contribution: 0,
                        ready: false,
                        score: 0,
                        online: true,
                        joinedAt: Date.now()
                    }
                },
                history: {}
            };
            
            database.ref(`rooms/${gameState.roomCode}`).set(roomData)
                .then(() => {
                    setupRoomListeners();
                    showLobby();
                })
                .catch(error => {
                    console.error('Error creating room:', error);
                    showError('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–Ω–∞—Ç—ã');
                });
        }
        
        // –ü–æ–∫–∞–∑ –ø–æ–ª—è –¥–ª—è –≤—Ö–æ–¥–∞ –≤ –∫–æ–º–Ω–∞—Ç—É
        function showJoinRoom() {
            document.getElementById('join-room-section').style.display = 'block';
        }
        
        // –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ –∫–æ–º–Ω–∞—Ç–µ
        function joinRoom() {
            const playerName = document.getElementById('player-name').value.trim();
            const roomCode = document.getElementById('room-code').value.trim().toUpperCase();
            
            if (!playerName) {
                showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è', 'name-error');
                return;
            }
            
            if (!roomCode || roomCode.length !== 6) {
                showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∫–æ–¥ –∫–æ–º–Ω–∞—Ç—ã');
                return;
            }
            
            if (!checkFirebaseConnection()) return;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã
            database.ref(`rooms/${roomCode}`).once('value')
                .then(snapshot => {
                    if (!snapshot.exists()) {
                        showError('–ö–æ–º–Ω–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–¥.');
                        return;
                    }
                    
                    const roomData = snapshot.val();
                    const playersCount = Object.keys(roomData.players || {}).length;
                    
                    if (playersCount >= 4) {
                        showError('–í –∫–æ–º–Ω–∞—Ç–µ —É–∂–µ 4 –∏–≥—Ä–æ–∫–∞.');
                        return;
                    }
                    
                    if (roomData.status !== 'waiting') {
                        showError('–ò–≥—Ä–∞ —É–∂–µ –Ω–∞—á–∞–ª–∞—Å—å –≤ —ç—Ç–æ–π –∫–æ–º–Ω–∞—Ç–µ.');
                        return;
                    }
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º —Å–µ–±—è –≤ –∫–æ–º–Ω–∞—Ç—É
                    gameState.playerName = playerName;
                    gameState.roomCode = roomCode;
                    gameState.isHost = false;
                    
                    const playerData = {
                        id: gameState.playerId,
                        name: playerName,
                        belief: 0,
                        contribution: 0,
                        ready: false,
                        score: 0,
                        online: true,
                        joinedAt: Date.now()
                    };
                    
                    database.ref(`rooms/${roomCode}/players/${gameState.playerId}`).set(playerData)
                        .then(() => {
                            setupRoomListeners();
                            showLobby();
                        })
                        .catch(error => {
                            console.error('Error joining room:', error);
                            showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏ –∫ –∫–æ–º–Ω–∞—Ç–µ');
                        });
                })
                .catch(error => {
                    console.error('Error checking room:', error);
                    showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
                });
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–ª—É—à–∞—Ç–µ–ª–µ–π –∫–æ–º–Ω–∞—Ç—ã
        function setupRoomListeners() {
            if (!gameState.roomCode) return;
            
            gameState.roomRef = database.ref(`rooms/${gameState.roomCode}`);
            gameState.playersRef = database.ref(`rooms/${gameState.roomCode}/players`);
            
            // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –∫–æ–º–Ω–∞—Ç–µ
            gameState.roomRef.on('value', handleRoomUpdate);
            
            // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å–ø–∏—Å–∫–∞ –∏–≥—Ä–æ–∫–æ–≤
            gameState.playersRef.on('value', handlePlayersUpdate);
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ presence
            setupPlayerPresence();
        }
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ presence –¥–ª—è –∏–≥—Ä–æ–∫–∞
        function setupPlayerPresence() {
            if (!gameState.roomCode || !gameState.playerId) return;
            
            const playerRef = database.ref(`rooms/${gameState.roomCode}/players/${gameState.playerId}`);
            const presenceRef = database.ref(`rooms/${gameState.roomCode}/players/${gameState.playerId}/online`);
            
            // –ü—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å online = false
            presenceRef.onDisconnect().set(false);
            
            // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å online = true
            presenceRef.set(true);
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –∫–æ–º–Ω–∞—Ç—ã
        function handleRoomUpdate(snapshot) {
            if (!snapshot.exists()) {
                showError('–ö–æ–º–Ω–∞—Ç–∞ –±—ã–ª–∞ —É–¥–∞–ª–µ–Ω–∞');
                leaveRoom();
                return;
            }
            
            const roomData = snapshot.val();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            gameState.currentRound = roomData.currentRound || 1;
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–º–µ–Ω—ã —Å—Ç–∞—Ç—É—Å–∞ –∏–≥—Ä—ã
            if (roomData.status === 'waiting' && gameState.currentScreen !== 'lobby-screen') {
                showLobby();
            } else if (roomData.status === 'playing') {
                if (gameState.currentScreen === 'lobby-screen') {
                    startGameRound(roomData);
                } else if (gameState.currentScreen === 'waiting-screen') {
                    showRoundResults(roomData);
                }
            } else if (roomData.status === 'results') {
                showRoundResults(roomData);
            } else if (roomData.status === 'finished') {
                showFinalResults(roomData);
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π —Å–ø–∏—Å–∫–∞ –∏–≥—Ä–æ–∫–æ–≤
        function handlePlayersUpdate(snapshot) {
            if (!snapshot.exists()) return;
            
            const players = snapshot.val();
            updateLobbyDisplay(players);
            
            if (gameState.currentScreen === 'round-screen') {
                updatePlayersStatus(players);
            } else if (gameState.currentScreen === 'waiting-screen') {
                updateWaitingStatus(players);
            }
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ª–æ–±–±–∏
        function showLobby() {
            showScreen('lobby-screen');
            document.getElementById('lobby-room-code').textContent = gameState.roomCode;
            document.getElementById('room-code-display').textContent = gameState.roomCode;
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ª–æ–±–±–∏
        function updateLobbyDisplay(players) {
            const playersArray = Object.values(players || {});
            const playersList = document.getElementById('players-list');
            const playerCount = document.getElementById('player-count');
            const readyCount = document.getElementById('ready-count');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏
            playerCount.textContent = playersArray.length;
            readyCount.textContent = playersArray.filter(p => p.ready).length;
            
            // –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤
            playersList.innerHTML = playersArray.map(player => {
                const isCurrentPlayer = player.id === gameState.playerId;
                const statusIcon = player.online ? 'üü¢' : 'üî¥';
                const readyIcon = player.ready ? '‚úÖ' : '‚è≥';
                const nameStyle = isCurrentPlayer ? 'font-weight: bold;' : '';
                
                return `
                    <div class="player-status ${isCurrentPlayer ? 'current-player' : ''}">
                        <span>${statusIcon} ${player.name} ${isCurrentPlayer ? '(–≤—ã)' : ''}</span>
                        <div class="status-indicator">
                            <span>${readyIcon}</span>
                            <span>${player.ready ? '–ì–æ—Ç–æ–≤' : '–û–∂–∏–¥–∞–Ω–∏–µ'}</span>
                        </div>
                    </div>
                `;
            }).join('');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≥–æ—Ç–æ–≤—ã –ª–∏ –≤—Å–µ –∏–≥—Ä–æ–∫–∏ –∫ —Å—Ç–∞—Ä—Ç—É
            if (playersArray.length === 4 && playersArray.every(p => p.ready) && gameState.isHost) {
                setTimeout(() => startGameForAllPlayers(), 1000);
            }
        }
        
        // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ –∫–æ–º–Ω–∞—Ç—ã
        function copyRoomCode() {
            navigator.clipboard.writeText(gameState.roomCode).then(() => {
                const element = document.getElementById('room-code-display');
                const originalText = element.textContent;
                element.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
                setTimeout(() => {
                    element.textContent = originalText;
                }, 1500);
            }).catch(() => {
                alert(`–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã: ${gameState.roomCode}`);
            });
        }
        
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
        function toggleReady() {
            if (!gameState.roomCode || !gameState.playerId) return;
            
            const playerRef = database.ref(`rooms/${gameState.roomCode}/players/${gameState.playerId}/ready`);
            
            playerRef.once('value').then(snapshot => {
                const currentReady = snapshot.val() || false;
                playerRef.set(!currentReady);
                
                const btn = document.getElementById('ready-btn');
                btn.textContent = !currentReady ? '–û—Ç–º–µ–Ω–∏—Ç—å –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å' : '–Ø –≥–æ—Ç–æ–≤!';
            });
        }
        
        // –ü–æ–∫–∏–Ω—É—Ç—å –∫–æ–º–Ω–∞—Ç—É
        function leaveRoom() {
            if (gameState.roomRef) {
                gameState.roomRef.off();
            }
            if (gameState.playersRef) {
                gameState.playersRef.off();
            }
            
            if (gameState.roomCode && gameState.playerId) {
                database.ref(`rooms/${gameState.roomCode}/players/${gameState.playerId}`).remove();
            }
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            gameState.roomCode = '';
            gameState.isHost = false;
            gameState.roomRef = null;
            gameState.playersRef = null;
            
            document.getElementById('player-name').value = '';
            document.getElementById('room-code').value = '';
            document.getElementById('join-room-section').style.display = 'none';
            
            showScreen('start-screen');
        }

        // –°—Ç–∞—Ä—Ç –∏–≥—Ä—ã –¥–ª—è –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤ (—Ç–æ–ª—å–∫–æ host)
        function startGameForAllPlayers() {
            if (!gameState.isHost) return;
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω—ã–µ –∏–∑–¥–µ—Ä–∂–∫–∏
            const actualCost = gameState.possibleCosts[Math.floor(Math.random() * gameState.possibleCosts.length)];
            
            const updates = {
                status: 'playing',
                actualCost: actualCost,
                roundStartTime: Date.now()
            };
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º ready —É –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤
            database.ref(`rooms/${gameState.roomCode}/players`).once('value').then(snapshot => {
                const players = snapshot.val();
                Object.keys(players).forEach(playerId => {
                    updates[`players/${playerId}/ready`] = false;
                    updates[`players/${playerId}/belief`] = 0;
                    updates[`players/${playerId}/contribution`] = 0;
                });
                
                database.ref(`rooms/${gameState.roomCode}`).update(updates);
            });
        }
        
        // –ù–∞—á–∞–ª–æ —Ä–∞—É–Ω–¥–∞ –¥–ª—è –∏–≥—Ä–æ–∫–∞
        function startGameRound(roomData) {
            showScreen('round-screen');
            updateRoundDisplay();
            renderExpectationOptions();
            updateHistory();
            updatePlayersStatus(roomData.players);
            updateScoresDisplay(roomData.players);
            document.getElementById('contribution-section').style.display = 'none';
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–∞—É–Ω–¥–∞
        function updateRoundDisplay() {
            document.getElementById('round-title').textContent = `–†–∞—É–Ω–¥ ${gameState.currentRound} –∏–∑ 5`;
            document.getElementById('progress-fill').style.width = `${(gameState.currentRound - 1) / 5 * 100}%`;
            
            if (gameState.currentRound > 1) {
                document.getElementById('history-section').style.display = 'block';
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∏–≥—Ä–æ–∫–æ–≤
        function updatePlayersStatus(players) {
            const playersArray = Object.values(players || {});
            const statusContainer = document.getElementById('players-status');
            
            statusContainer.innerHTML = playersArray.map(player => {
                const isCurrentPlayer = player.id === gameState.playerId;
                let statusText = 'üí≠ –î—É–º–∞–µ—Ç...';
                let statusColor = 'var(--color-text-secondary)';
                
                if (player.ready) {
                    statusText = '‚úÖ –ì–æ—Ç–æ–≤!';
                    statusColor = 'var(--color-success)';
                }
                
                if (!player.online) {
                    statusText = 'üî¥ –û—Ñ–ª–∞–π–Ω';
                    statusColor = 'var(--color-error)';
                }
                
                return `
                    <div style="display: flex; justify-content: space-between; padding: 4px 0; ${isCurrentPlayer ? 'font-weight: bold;' : ''}">
                        <span>${player.name} ${isCurrentPlayer ? '(–≤—ã)' : ''}</span>
                        <span style="color: ${statusColor};">${statusText}</span>
                    </div>
                `;
            }).join('');
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—á–∫–æ–≤
        function updateScoresDisplay(players) {
            const playersArray = Object.values(players || {});
            const scoresContainer = document.getElementById('scores-display');
            
            scoresContainer.innerHTML = playersArray.map(player => {
                const isCurrentPlayer = player.id === gameState.playerId;
                return `
                    <div style="display: flex; justify-content: space-between; padding: 4px 0; ${isCurrentPlayer ? 'font-weight: bold;' : ''}">
                        <span>${player.name} ${isCurrentPlayer ? '(–≤—ã)' : ''}</span>
                        <span>${player.score || 0} –æ—á–∫–æ–≤</span>
                    </div>
                `;
            }).join('');
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –ø—Ä–æ–≥–Ω–æ–∑–∞
        function renderExpectationOptions() {
            const container = document.getElementById('expectation-options');
            container.innerHTML = '';
            
            gameState.possibleCosts.forEach(cost => {
                const option = document.createElement('div');
                option.className = 'radio-option';
                option.onclick = () => selectExpectation(cost);
                option.innerHTML = `
                    <input type="radio" name="expectation" value="${cost}" style="margin-right: 8px;">
                    <span>${cost} –º–æ–Ω–µ—Ç</span>
                `;
                container.appendChild(option);
            });
        }

        // –í—ã–±–æ—Ä –ø—Ä–æ–≥–Ω–æ–∑–∞
        function selectExpectation(cost) {
            document.querySelectorAll('#expectation-options .radio-option').forEach(option => {
                option.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            event.currentTarget.querySelector('input').checked = true;
            
            document.getElementById('selected-expectation').textContent = cost;
            document.getElementById('contribution-section').style.display = 'block';
            document.getElementById('step1-error').style.display = 'none';
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–ª–∞–π–¥–µ—Ä–∞
        function setupSlider() {
            const slider = document.getElementById('contribution-slider');
            const display = document.getElementById('contribution-value');
            
            slider.oninput = function() {
                display.textContent = `${this.value} –º–æ–Ω–µ—Ç`;
            };
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–µ—à–µ–Ω–∏–π —Ä–∞—É–Ω–¥–∞
        function submitRound() {
            const expectationInput = document.querySelector('input[name="expectation"]:checked');
            const contributionSlider = document.getElementById('contribution-slider');
            
            if (!expectationInput) {
                document.getElementById('step1-error').textContent = '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à –ø—Ä–æ–≥–Ω–æ–∑';
                document.getElementById('step1-error').style.display = 'block';
                return;
            }
            
            const expectation = parseInt(expectationInput.value);
            const contribution = parseInt(contributionSlider.value);
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ—à–µ–Ω–∏—è –≤ Firebase
            const playerUpdates = {
                belief: expectation,
                contribution: contribution,
                ready: true
            };
            
            database.ref(`rooms/${gameState.roomCode}/players/${gameState.playerId}`).update(playerUpdates)
                .then(() => {
                    showScreen('waiting-screen');
                })
                .catch(error => {
                    console.error('Error submitting round:', error);
                    showError('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ä–µ—à–µ–Ω–∏–π');
                });
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –æ–∂–∏–¥–∞–Ω–∏—è
        function updateWaitingStatus(players) {
            const playersArray = Object.values(players || {});
            const readyCount = playersArray.filter(p => p.ready).length;
            const waitingContainer = document.getElementById('waiting-status');
            
            waitingContainer.innerHTML = `
                <p class="mb-16">–ì–æ—Ç–æ–≤–æ: ${readyCount}/4 –∏–≥—Ä–æ–∫–æ–≤</p>
                ${playersArray.map(player => {
                    const icon = player.ready ? '‚úÖ' : '‚è≥';
                    const status = player.ready ? '–ì–æ—Ç–æ–≤' : '–î—É–º–∞–µ—Ç...';
                    return `<p>${icon} ${player.name}: ${status}</p>`;
                }).join('')}
            `;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≥–æ—Ç–æ–≤—ã –ª–∏ –≤—Å–µ
            if (readyCount === 4 && gameState.isHost) {
                setTimeout(() => calculateRoundResults(players), 1500);
            }
        }

        // –†–∞—Å—á–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ä–∞—É–Ω–¥–∞ (—Ç–æ–ª—å–∫–æ host)
        function calculateRoundResults(players) {
            if (!gameState.isHost) return;
            
            // –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∏–∑–¥–µ—Ä–∂–∫–∏
            database.ref(`rooms/${gameState.roomCode}/actualCost`).once('value').then(snapshot => {
                const actualCost = snapshot.val();
                const playersArray = Object.values(players);
                
                // –°—á–∏—Ç–∞–µ–º –æ–±—â–∏–µ –≤–∑–Ω–æ—Å—ã
                const totalContribution = playersArray.reduce((sum, player) => sum + (player.contribution || 0), 0);
                const projectSuccess = totalContribution >= actualCost;
                
                // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –≤—ã–∏–≥—Ä—ã—à–∏
                const roundResults = {};
                const scoreUpdates = {};
                const contributions = {};
                
                playersArray.forEach(player => {
                    const payoff = projectSuccess ? 50 - player.contribution : -player.contribution;
                    const newScore = (player.score || 0) + payoff;
                    
                    roundResults[player.id] = {
                        expectation: player.belief,
                        contribution: player.contribution,
                        payoff: payoff
                    };
                    
                    contributions[player.id] = player.contribution;
                    scoreUpdates[`players/${player.id}/score`] = newScore;
                    scoreUpdates[`players/${player.id}/ready`] = false;
                });
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ –∏—Å—Ç–æ—Ä–∏—é
                const historyData = {
                    actualCost: actualCost,
                    totalContributions: totalContribution,
                    success: projectSuccess,
                    contributions: contributions,
                    results: roundResults
                };
                
                const updates = {
                    ...scoreUpdates,
                    [`history/round${gameState.currentRound}`]: historyData,
                    status: 'results'
                };
                
                database.ref(`rooms/${gameState.roomCode}`).update(updates);
            });
        }

        // –ü–æ–∫–∞–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ä–∞—É–Ω–¥–∞
        function showRoundResults(roomData) {
            showScreen('results-screen');
            
            const currentRoundHistory = roomData.history[`round${gameState.currentRound}`];
            if (!currentRoundHistory) return;
            
            document.getElementById('results-title').textContent = `–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—É–Ω–¥–∞ ${gameState.currentRound}`;
            
            // –¢–∞–±–ª–∏—Ü–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≥—Ä—É–ø–ø—ã
            const playersArray = Object.values(roomData.players || {});
            const table = document.getElementById('round-results-table');
            table.innerHTML = '';
            
            playersArray.forEach(player => {
                const result = currentRoundHistory.results[player.id];
                if (result) {
                    const row = table.insertRow();
                    row.innerHTML = `
                        <td><strong>${player.name}</strong></td>
                        <td>${result.expectation}</td>
                        <td>${result.contribution}</td>
                    `;
                }
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É —Å –∏—Ç–æ–≥–∞–º–∏
            const summaryRow = table.insertRow();
            summaryRow.style.borderTop = '2px solid var(--color-border)';
            summaryRow.innerHTML = `
                <td><strong>–°—É–º–º–∞ –≥—Ä—É–ø–ø—ã</strong></td>
                <td>-</td>
                <td><strong>${currentRoundHistory.totalContributions}</strong></td>
            `;
            
            const costRow = table.insertRow();
            costRow.innerHTML = `
                <td><strong>–†–µ–∞–ª—å–Ω—ã–µ –∏–∑–¥–µ—Ä–∂–∫–∏</strong></td>
                <td>-</td>
                <td><strong>${currentRoundHistory.actualCost}</strong></td>
            `;
            
            // –°—Ç–∞—Ç—É—Å –ø—Ä–æ–µ–∫—Ç–∞
            const statusElement = document.getElementById('project-status');
            if (currentRoundHistory.success) {
                statusElement.innerHTML = '<span class="status status--success">–°–û–ó–î–ê–ù</span>';
            } else {
                statusElement.innerHTML = '<span class="status status--error">–ü–†–û–í–ê–õ–ï–ù</span>';
            }
            
            // –í–∞—à–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            const myResult = currentRoundHistory.results[gameState.playerId];
            if (myResult) {
                document.getElementById('round-payoff').textContent = myResult.payoff > 0 ? `+${myResult.payoff}` : myResult.payoff;
            }
            
            const myPlayer = playersArray.find(p => p.id === gameState.playerId);
            if (myPlayer) {
                document.getElementById('total-payoff').textContent = myPlayer.score || 0;
            }
            
            // –ö–Ω–æ–ø–∫–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ä–∞—É–Ω–¥–∞
            const nextBtn = document.getElementById('next-round-btn');
            if (gameState.currentRound >= 5) {
                nextBtn.textContent = '–§–∏–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã';
                nextBtn.onclick = () => {
                    if (gameState.isHost) {
                        database.ref(`rooms/${gameState.roomCode}/status`).set('finished');
                    }
                };
            } else {
                nextBtn.onclick = () => nextRound();
            }
        }

        // –°–ª–µ–¥—É—é—â–∏–π —Ä–∞—É–Ω–¥ (—Ç–æ–ª—å–∫–æ host)
        function nextRound() {
            if (!gameState.isHost) return;
            
            const nextRoundNumber = gameState.currentRound + 1;
            
            if (nextRoundNumber > 5) {
                database.ref(`rooms/${gameState.roomCode}/status`).set('finished');
                return;
            }
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–µ —Å–ª—É—á–∞–π–Ω—ã–µ –∏–∑–¥–µ—Ä–∂–∫–∏
            const actualCost = gameState.possibleCosts[Math.floor(Math.random() * gameState.possibleCosts.length)];
            
            const updates = {
                currentRound: nextRoundNumber,
                actualCost: actualCost,
                status: 'playing',
                roundStartTime: Date.now()
            };
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º ready, belief, contribution —É –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤
            database.ref(`rooms/${gameState.roomCode}/players`).once('value').then(snapshot => {
                const players = snapshot.val();
                Object.keys(players).forEach(playerId => {
                    updates[`players/${playerId}/ready`] = false;
                    updates[`players/${playerId}/belief`] = 0;
                    updates[`players/${playerId}/contribution`] = 0;
                });
                
                database.ref(`rooms/${gameState.roomCode}`).update(updates);
            });
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –∏–≥—Ä—ã
        function updateHistory() {
            if (gameState.currentRound <= 1) return;
            
            database.ref(`rooms/${gameState.roomCode}/history`).once('value').then(snapshot => {
                const history = snapshot.val() || {};
                const table = document.getElementById('history-table');
                table.innerHTML = '';
                
                for (let round = 1; round < gameState.currentRound; round++) {
                    const roundData = history[`round${round}`];
                    if (roundData && roundData.results && roundData.results[gameState.playerId]) {
                        const myResult = roundData.results[gameState.playerId];
                        const row = table.insertRow();
                        row.innerHTML = `
                            <td>${round}</td>
                            <td>${myResult.expectation}</td>
                            <td>${myResult.contribution}</td>
                            <td>${roundData.actualCost}</td>
                            <td>${roundData.success ? '<span class="status status--success">–°–æ–∑–¥–∞–Ω</span>' : '<span class="status status--error">–ü—Ä–æ–≤–∞–ª–µ–Ω</span>'}</td>
                            <td>${myResult.payoff > 0 ? '+' : ''}${myResult.payoff}</td>
                        `;
                    }
                }
            });
        }





        // –§–∏–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        function showFinalResults(roomData) {
            showScreen('final-screen');
            
            const playersArray = Object.values(roomData.players || {});
            const myPlayer = playersArray.find(p => p.id === gameState.playerId);
            const history = roomData.history || {};
            
            // –ú–æ–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            if (myPlayer) {
                const totalPayoff = myPlayer.score || 0;
                const averagePayoff = (totalPayoff / 5).toFixed(1);
                const successfulProjects = Object.values(history).filter(round => round.success).length;
                
                document.getElementById('final-total-payoff').textContent = totalPayoff;
                document.getElementById('average-payoff').textContent = averagePayoff;
                document.getElementById('successful-projects').textContent = successfulProjects;
            }
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∏–≥—Ä–æ–∫–æ–≤ –ø–æ –æ—á–∫–∞–º –∏ —Å–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –ª–∏–¥–µ—Ä–æ–≤
            const sortedPlayers = playersArray.sort((a, b) => (b.score || 0) - (a.score || 0));
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É –ª–∏–¥–µ—Ä–æ–≤ –ø–µ—Ä–µ–¥ –º–æ–∏–º–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
            const leaderboardCard = document.querySelector('#final-screen .card');
            const existingLeaderboard = document.getElementById('leaderboard-table');
            if (!existingLeaderboard) {
                const leaderboardHtml = `
                    <div>
                        <h3>üèÜ –¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤</h3>
                        <table class="table" id="leaderboard-table">
                            <thead>
                                <tr>
                                    <th>–ú–µ—Å—Ç–æ</th>
                                    <th>–ò–º—è</th>
                                    <th>–û—á–∫–∏</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sortedPlayers.map((player, index) => {
                                    const isCurrentPlayer = player.id === gameState.playerId;
                                    const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}.`;
                                    return `
                                        <tr style="${isCurrentPlayer ? 'font-weight: bold; background-color: var(--color-bg-3);' : ''}">
                                            <td>${medal}</td>
                                            <td>${player.name} ${isCurrentPlayer ? '(–≤—ã)' : ''}</td>
                                            <td>${player.score || 0}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                const gridDiv = leaderboardCard.querySelector('.grid');
                if (gridDiv) {
                    gridDiv.innerHTML = leaderboardHtml + gridDiv.innerHTML;
                }
            }
            
            // –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (—Ç–æ–ª—å–∫–æ –º–æ–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã)
            const table = document.getElementById('final-results-table');
            table.innerHTML = '';
            
            for (let round = 1; round <= 5; round++) {
                const roundData = history[`round${round}`];
                if (roundData && roundData.results && roundData.results[gameState.playerId]) {
                    const myResult = roundData.results[gameState.playerId];
                    const row = table.insertRow();
                    row.innerHTML = `
                        <td>${round}</td>
                        <td>${myResult.expectation}</td>
                        <td>${myResult.contribution}</td>
                        <td>${roundData.actualCost}</td>
                        <td>${roundData.totalContributions}</td>
                        <td>${roundData.success ? '<span class="status status--success">–°–æ–∑–¥–∞–Ω</span>' : '<span class="status status--error">–ü—Ä–æ–≤–∞–ª–µ–Ω</span>'}</td>
                        <td>${myResult.payoff > 0 ? '+' : ''}${myResult.payoff}</td>
                    `;
                }
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è CSV
            gameState.finalRoomData = roomData;
            
            // –ì—Ä–∞—Ñ–∏–∫
            createPayoffChart();
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞
        function createPayoffChart() {
            const ctx = document.getElementById('payoff-chart').getContext('2d');
            
            if (!gameState.finalRoomData || !gameState.finalRoomData.history) {
                return;
            }
            
            const history = gameState.finalRoomData.history;
            const cumulativePayoffs = [];
            let cumulative = 0;
            
            for (let round = 1; round <= 5; round++) {
                const roundData = history[`round${round}`];
                if (roundData && roundData.results && roundData.results[gameState.playerId]) {
                    const payoff = roundData.results[gameState.playerId].payoff;
                    cumulative += payoff;
                }
                cumulativePayoffs.push(cumulative);
            }
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['–†–∞—É–Ω–¥ 1', '–†–∞—É–Ω–¥ 2', '–†–∞—É–Ω–¥ 3', '–†–∞—É–Ω–¥ 4', '–†–∞—É–Ω–¥ 5'],
                    datasets: [{
                        label: '–ù–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–π –≤—ã–∏–≥—Ä—ã—à',
                        data: cumulativePayoffs,
                        borderColor: '#1FB8CD',
                        backgroundColor: 'rgba(31, 184, 205, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: '–ú–æ–Ω–µ—Ç—ã'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // –°–∫–∞—á–∏–≤–∞–Ω–∏–µ CSV
        function downloadResults() {
            if (!gameState.finalRoomData) {
                alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞');
                return;
            }
            
            const headers = ['Room_Code', 'Player_ID', 'Player_Name', 'Round', 'Belief', 'Contribution', 'Actual_Cost', 'Total_Contributions', 'Project_Success', 'Payoff', 'Total_Score'];
            const rows = [headers];
            
            const playersArray = Object.values(gameState.finalRoomData.players || {});
            const history = gameState.finalRoomData.history || {};
            
            // –î–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤ –ø–æ –≤—Å–µ–º —Ä–∞—É–Ω–¥–∞–º
            playersArray.forEach(player => {
                for (let round = 1; round <= 5; round++) {
                    const roundData = history[`round${round}`];
                    if (roundData && roundData.results && roundData.results[player.id]) {
                        const result = roundData.results[player.id];
                        rows.push([
                            gameState.roomCode,
                            player.id,
                            player.name,
                            round,
                            result.expectation,
                            result.contribution,
                            roundData.actualCost,
                            roundData.totalContributions,
                            roundData.success ? 'Success' : 'Failure',
                            result.payoff,
                            player.score || 0
                        ]);
                    }
                }
            });
            
            const csvContent = '\uFEFF' + rows.map(row => row.join(',')).join('\n'); // –î–æ–±–∞–≤–ª—è–µ–º BOM –¥–ª—è UTF-8
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            const timestamp = new Date().toISOString().slice(0, 16).replace(/[T:]/g, '_');
            link.href = URL.createObjectURL(blob);
            link.download = `multiplayer_experiment_${gameState.roomCode}_${timestamp}.csv`;
            link.click();
        }

        // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∏–≥—Ä—ã
        function restartGame() {
            // –û—á–∏—â–∞–µ–º —Å–ª—É—à–∞—Ç–µ–ª–∏
            if (gameState.roomRef) {
                gameState.roomRef.off();
            }
            if (gameState.playersRef) {
                gameState.playersRef.off();
            }
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            gameState.playerId = generatePlayerId();
            gameState.playerName = '';
            gameState.roomCode = '';
            gameState.isHost = false;
            gameState.currentRound = 1;
            gameState.roomRef = null;
            gameState.playersRef = null;
            gameState.gameHistory = [];
            gameState.finalRoomData = null;
            
            // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—ã
            document.getElementById('player-name').value = '';
            document.getElementById('room-code').value = '';
            document.getElementById('join-room-section').style.display = 'none';
            
            showScreen('start-screen');
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', initGame);
        
        // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã/–≤–∫–ª–∞–¥–∫–∏
        window.addEventListener('beforeunload', () => {
            if (gameState.roomCode && gameState.playerId) {
                // –û—Ç–º–µ—á–∞–µ–º –∏–≥—Ä–æ–∫–∞ –∫–∞–∫ –æ—Ñ–ª–∞–π–Ω
                database.ref(`rooms/${gameState.roomCode}/players/${gameState.playerId}/online`).set(false);
            }
        });
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –æ—Ç —Å–µ—Ç–∏
        window.addEventListener('online', () => {
            if (gameState.roomCode && gameState.playerId) {
                database.ref(`rooms/${gameState.roomCode}/players/${gameState.playerId}/online`).set(true);
            }
        });
        
        window.addEventListener('offline', () => {
            if (gameState.roomCode && gameState.playerId) {
                database.ref(`rooms/${gameState.roomCode}/players/${gameState.playerId}/online`).set(false);
            }
        });
    </script>
</body>
</html>
