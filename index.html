<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Экономический эксперимент: Дилемма распределения издержек</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .main-container {
            max-width: 900px;
            margin: 30px auto;
            padding: 20px;
        }
        .game-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            animation: fadeIn 0.5s;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .room-code {
            font-size: 2.5rem;
            font-weight: bold;
            color: #667eea;
            letter-spacing: 5px;
            cursor: pointer;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            transition: all 0.3s;
        }
        .room-code:hover {
            background: #e9ecef;
            transform: scale(1.05);
        }
        .player-item {
            padding: 15px;
            margin: 10px 0;
            background: #f8f9fa;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .player-ready {
            background: #d4edda;
            border: 2px solid #28a745;
        }
        .slider-container {
            margin: 30px 0;
        }
        .contribution-value {
            font-size: 2rem;
            color: #667eea;
            font-weight: bold;
        }
        .results-table {
            margin-top: 20px;
        }
        .success-badge {
            background: #28a745;
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 1.2rem;
        }
        .fail-badge {
            background: #dc3545;
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 1.2rem;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            padding: 12px 30px;
            font-size: 1.1rem;
            border-radius: 10px;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .progress-bar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .waiting-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="game-card" id="gameContainer">
            <!-- Контент будет динамически загружаться здесь -->
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // FIREBASE КОНФИГУРАЦИЯ (УЖЕ ПОДСТАВЛЕНА)
        const firebaseConfig = {
            apiKey: "AIzaSyBdqtRnPhfqgYJYSMR5TZucmVHTuE4WTY8",
            authDomain: "cost-sharing-game.firebaseapp.com",
            databaseURL: "https://cost-sharing-game-default-rtdb.firebaseio.com",
            projectId: "cost-sharing-game",
            storageBucket: "cost-sharing-game.firebasestorage.app",
            messagingSenderId: "882128282715",
            appId: "1:882128282715:web:2fc86b8c68cbf3ccc44b7e"
        };

        // Инициализация Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Глобальные переменные
        let playerName = '';
        let playerId = '';
        let roomCode = '';
        let isHost = false;
        let currentRoomRef = null;

        // Параметры игры
        const GAME_PARAMS = {
            maxPlayers: 4,
            numRounds: 5,
            initialCapital: 100,
            benefitValue: 200,
            individualBenefit: 50,
            possibleCosts: [60, 80, 100, 120, 140]
        };

        // Генерация уникального ID игрока
        function generatePlayerId() {
            return 'player_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // Генерация кода комнаты
        function generateRoomCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        // ЭКРАН 1: Главный экран
        function showHomeScreen() {
            const container = document.getElementById('gameContainer');
            container.innerHTML = `
                <h1 class="text-center mb-4">Многопользовательский экономический эксперимент</h1>
                <p class="text-center text-muted mb-4">Дилемма распределения издержек</p>
                
                <div class="mb-4">
                    <label class="form-label">Введите ваше имя:</label>
                    <input type="text" id="playerNameInput" class="form-control" placeholder="Ваше имя">
                </div>

                <div class="d-grid gap-3">
                    <button class="btn btn-primary btn-lg" onclick="createRoom()">Создать новую комнату</button>
                    <div class="text-center">или</div>
                    <div class="input-group">
                        <input type="text" id="joinRoomInput" class="form-control" placeholder="Введите код комнаты" maxlength="6">
                        <button class="btn btn-primary" onclick="joinRoom()">Присоединиться</button>
                    </div>
                </div>

                <div class="mt-5">
                    <h5>Краткие правила:</h5>
                    <ul class="text-muted">
                        <li>В группе 4 игрока</li>
                        <li>5 раундов</li>
                        <li>Каждый раунд: прогноз издержек → взнос</li>
                        <li>Если сумма взносов ≥ издержки → проект создан</li>
                        <li>Цель: максимизировать свой итоговый счет</li>
                    </ul>
                </div>
            `;
        }

        // Создание комнаты
        function createRoom() {
            playerName = document.getElementById('playerNameInput').value.trim();
            if (!playerName) {
                alert('Пожалуйста, введите ваше имя');
                return;
            }

            playerId = generatePlayerId();
            roomCode = generateRoomCode();
            isHost = true;

            const roomData = {
                status: 'waiting',
                currentRound: 1,
                host: playerId,
                createdAt: Date.now(),
                players: {}
            };

            roomData.players[playerId] = {
                name: playerName,
                score: 0,
                ready: false,
                online: true,
                joinedAt: Date.now()
            };

            database.ref(`rooms/${roomCode}`).set(roomData).then(() => {
                currentRoomRef = database.ref(`rooms/${roomCode}`);
                setupPresence();
                listenToRoom();
                showLobby();
            }).catch(error => {
                alert('Ошибка создания комнаты: ' + error.message);
            });
        }

        // Присоединение к комнате
        function joinRoom() {
            playerName = document.getElementById('playerNameInput').value.trim();
            const code = document.getElementById('joinRoomInput').value.trim().toUpperCase();

            if (!playerName) {
                alert('Пожалуйста, введите ваше имя');
                return;
            }

            if (code.length !== 6) {
                alert('Код комнаты должен содержать 6 символов');
                return;
            }

            roomCode = code;
            playerId = generatePlayerId();

            database.ref(`rooms/${roomCode}`).once('value', snapshot => {
                if (!snapshot.exists()) {
                    alert('Комната не найдена');
                    return;
                }

                const roomData = snapshot.val();
                const playerCount = Object.keys(roomData.players || {}).length;

                if (playerCount >= GAME_PARAMS.maxPlayers) {
                    alert('Комната заполнена (максимум 4 игрока)');
                    return;
                }

                database.ref(`rooms/${roomCode}/players/${playerId}`).set({
                    name: playerName,
                    score: 0,
                    ready: false,
                    online: true,
                    joinedAt: Date.now()
                }).then(() => {
                    currentRoomRef = database.ref(`rooms/${roomCode}`);
                    setupPresence();
                    listenToRoom();
                    showLobby();
                }).catch(error => {
                    alert('Ошибка присоединения: ' + error.message);
                });
            });
        }

        // Настройка presence (отслеживание онлайн)
        function setupPresence() {
            const playerRef = database.ref(`rooms/${roomCode}/players/${playerId}`);
            playerRef.child('online').onDisconnect().set(false);
        }

        // Слушатель изменений комнаты
        function listenToRoom() {
            currentRoomRef.on('value', snapshot => {
                if (!snapshot.exists()) {
                    alert('Комната была удалена');
                    showHomeScreen();
                    return;
                }

                const roomData = snapshot.val();
                console.log('Room update:', roomData.status, 'Round:', roomData.currentRound);

                if (roomData.status === 'waiting') {
                    showLobby();
                } else if (roomData.status === 'playing') {
                    const playerData = roomData.players[playerId];
                    
                    if (!playerData.belief) {
                        showBeliefScreen(roomData);
                    } else if (!playerData.contribution && playerData.contribution !== 0) {
                        showContributionScreen(roomData);
                    } else if (!playerData.ready) {
                        // Игрок сделал вклад, ставим ready
                        database.ref(`rooms/${roomCode}/players/${playerId}/ready`).set(true);
                        showWaitingScreen(roomData);
                    } else if (roomData.roundResults) {
                        showRoundResults(roomData);
                    } else {
                        showWaitingScreen(roomData);
                    }
                } else if (roomData.status === 'finished') {
                    showFinalResults(roomData);
                }
            });
        }

        // ЭКРАН 2: Лобби
        function showLobby() {
            currentRoomRef.once('value', snapshot => {
                const roomData = snapshot.val();
                const players = roomData.players || {};
                const playerCount = Object.keys(players).length;
                const readyCount = Object.values(players).filter(p => p.ready).length;

                const container = document.getElementById('gameContainer');
                container.innerHTML = `
                    <h2 class="text-center mb-4">Комната ожидания</h2>
                    
                    <div class="text-center mb-4">
                        <p class="mb-2">Код комнаты:</p>
                        <div class="room-code" onclick="copyRoomCode()" title="Нажмите, чтобы скопировать">${roomCode}</div>
                        <small class="text-muted">Нажмите, чтобы скопировать</small>
                    </div>

                    <div class="mb-4">
                        <h5>Игроки в комнате (${playerCount}/${GAME_PARAMS.maxPlayers}):</h5>
                        <div id="playersList"></div>
                    </div>

                    <div class="mb-4">
                        <div class="progress" style="height: 30px;">
                            <div class="progress-bar" role="progressbar" style="width: ${(readyCount/GAME_PARAMS.maxPlayers)*100}%">
                                Игроков готово: ${readyCount}/${GAME_PARAMS.maxPlayers}
                            </div>
                        </div>
                    </div>

                    <div class="d-grid gap-2">
                        <button class="btn btn-primary btn-lg" id="readyBtn" onclick="setReady()">
                            ${players[playerId]?.ready ? '✓ Вы готовы!' : 'Я готов!'}
                        </button>
                        <button class="btn btn-outline-secondary" onclick="leaveRoom()">Покинуть комнату</button>
                    </div>

                    ${playerCount === GAME_PARAMS.maxPlayers && readyCount === GAME_PARAMS.maxPlayers ? 
                        '<div class="alert alert-success mt-3">Все готовы! Игра начинается...</div>' : 
                        '<div class="alert alert-info mt-3">Ожидание игроков...</div>'}
                `;

                // Отображаем список игроков
                const playersListDiv = document.getElementById('playersList');
                Object.entries(players).forEach(([pid, player]) => {
                    const isCurrentPlayer = pid === playerId;
                    const statusIcon = player.ready ? '✅' : '⏳';
                    const statusText = player.ready ? 'Готов' : 'Ожидание';
                    
                    playersListDiv.innerHTML += `
                        <div class="player-item ${player.ready ? 'player-ready' : ''}">
                            <span>${statusIcon} ${player.name} ${isCurrentPlayer ? '(Вы)' : ''}</span>
                            <span class="badge bg-secondary">${statusText}</span>
                        </div>
                    `;
                });

                // Автостарт
                if (isHost && playerCount === GAME_PARAMS.maxPlayers && readyCount === GAME_PARAMS.maxPlayers) {
                    setTimeout(() => startGame(), 2000);
                }
            });
        }

        function copyRoomCode() {
            navigator.clipboard.writeText(roomCode);
            alert('Код комнаты скопирован: ' + roomCode);
        }

        function setReady() {
            database.ref(`rooms/${roomCode}/players/${playerId}/ready`).set(true);
        }

        function leaveRoom() {
            if (currentRoomRef) {
                currentRoomRef.off();
                database.ref(`rooms/${roomCode}/players/${playerId}`).remove();
            }
            showHomeScreen();
        }

        function startGame() {
            database.ref(`rooms/${roomCode}`).update({
                status: 'playing',
                currentRound: 1
            });
            
            // Сбрасываем ready у всех
            currentRoomRef.child('players').once('value', snapshot => {
                const updates = {};
                snapshot.forEach(childSnapshot => {
                    updates[`players/${childSnapshot.key}/ready`] = false;
                    updates[`players/${childSnapshot.key}/belief`] = null;
                    updates[`players/${childSnapshot.key}/contribution`] = null;
                });
                database.ref(`rooms/${roomCode}`).update(updates);
            });
        }

        // ЭКРАН 3: Опрос ожиданий
        function showBeliefScreen(roomData) {
            const container = document.getElementById('gameContainer');
            container.innerHTML = `
                <h2 class="text-center mb-4">Раунд ${roomData.currentRound} из ${GAME_PARAMS.numRounds}</h2>
                
                <div class="alert alert-info">
                    <strong>Шаг 1:</strong> Какими будут реальные издержки в этом раунде?
                </div>

                <div class="mb-4">
                    <h5>Ваш прогноз:</h5>
                    ${GAME_PARAMS.possibleCosts.map(cost => `
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="radio" name="belief" id="belief${cost}" value="${cost}">
                            <label class="form-check-label" for="belief${cost}">
                                ${cost} монет
                            </label>
                        </div>
                    `).join('')}
                </div>

                <button class="btn btn-primary btn-lg w-100" onclick="submitBelief()">Далее</button>
            `;
        }

        function submitBelief() {
            const selected = document.querySelector('input[name="belief"]:checked');
            if (!selected) {
                alert('Выберите ваш прогноз');
                return;
            }

            database.ref(`rooms/${roomCode}/players/${playerId}/belief`).set(parseInt(selected.value));
        }

        // ЭКРАН 4: Ввод взноса
        function showContributionScreen(roomData) {
            const playerBelief = roomData.players[playerId].belief;
            const container = document.getElementById('gameContainer');
            
            container.innerHTML = `
                <h2 class="text-center mb-4">Раунд ${roomData.currentRound} из ${GAME_PARAMS.numRounds}</h2>
                
                <div class="alert alert-success">
                    Ваш прогноз: <strong>${playerBelief} монет</strong>
                </div>

                <div class="alert alert-info">
                    <strong>Шаг 2:</strong> Какой взнос вы готовы сделать?
                </div>

                <div class="slider-container">
                    <label class="form-label">Ваш взнос:</label>
                    <div class="text-center contribution-value mb-3">
                        <span id="contributionDisplay">50</span> монет
                    </div>
                    <input type="range" class="form-range" id="contributionSlider" min="0" max="100" value="50" 
                           oninput="document.getElementById('contributionDisplay').textContent = this.value">
                </div>

                <div class="alert alert-warning">
                    <small>
                        • Если сумма всех взносов ≥ реальные издержки → проект создан, вы получите 50 - ваш_взнос<br>
                        • Если сумма < издержки → проект провален, вы теряете взнос
                    </small>
                </div>

                <button class="btn btn-primary btn-lg w-100" onclick="submitContribution()">Подтвердить взнос</button>
            `;
        }

        function submitContribution() {
            const contribution = parseInt(document.getElementById('contributionSlider').value);
            
            database.ref(`rooms/${roomCode}/players/${playerId}`).update({
                contribution: contribution,
                ready: true
            }).then(() => {
                checkAllReady();
            });
        }

        // ЭКРАН 5: Ожидание других
        function showWaitingScreen(roomData) {
            const players = roomData.players || {};
            const readyCount = Object.values(players).filter(p => p.ready).length;
            const totalPlayers = Object.keys(players).length;

            const container = document.getElementById('gameContainer');
            container.innerHTML = `
                <h2 class="text-center mb-4">Раунд ${roomData.currentRound} из ${GAME_PARAMS.numRounds}</h2>
                
                <div class="text-center mb-4">
                    <div class="waiting-spinner mb-3" style="width: 60px; height: 60px; border-width: 6px;"></div>
                    <h4>Ваши решения отправлены. Ждем остальных.</h4>
                </div>

                <div class="progress mb-3" style="height: 30px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" 
                         style="width: ${(readyCount/totalPlayers)*100}%">
                        ${readyCount}/${totalPlayers} игроков готовы
                    </div>
                </div>

                <div class="alert alert-info">
                    💡 Когда все игроки сделают свой выбор, мы покажем результаты раунда.
                </div>
            `;
        }

        // Проверка готовности всех игроков
        function checkAllReady() {
            currentRoomRef.once('value', snapshot => {
                const roomData = snapshot.val();
                const players = roomData.players || {};
                const allReady = Object.values(players).every(p => p.ready);
                const playerCount = Object.keys(players).length;

                console.log('Check ready:', Object.values(players).filter(p => p.ready).length, '/', playerCount);

                if (allReady && playerCount > 0 && !roomData.roundResults) {
                    calculateRoundResults();
                }
            });
        }

        // Расчет результатов раунда (любой игрок может запустить)
        function calculateRoundResults() {
            const roundResultsRef = database.ref(`rooms/${roomCode}/roundResults`);
            
            roundResultsRef.transaction(current => {
                if (current) return; // Уже посчитано
                return true;
            }, (error, committed, snapshot) => {
                if (committed && snapshot.val() === true) {
                    console.log('Calculating results...');
                    
                    currentRoomRef.once('value', snap => {
                        const roomData = snap.val();
                        const players = roomData.players;
                        const currentRound = roomData.currentRound;

                        // Случайная стоимость
                        const actualCost = GAME_PARAMS.possibleCosts[
                            Math.floor(Math.random() * GAME_PARAMS.possibleCosts.length)
                        ];

                        // Суммируем взносы
                        let totalContributions = 0;
                        const contributions = {};
                        Object.entries(players).forEach(([pid, p]) => {
                            contributions[pid] = p.contribution || 0;
                            totalContributions += contributions[pid];
                        });

                        const success = totalContributions >= actualCost;

                        // Выигрыши
                        const updates = {};
                        Object.entries(players).forEach(([pid, p]) => {
                            const payoff = success ? (GAME_PARAMS.individualBenefit - contributions[pid]) : -contributions[pid];
                            const newScore = (p.score || 0) + payoff;
                            updates[`players/${pid}/score`] = newScore;
                            updates[`players/${pid}/roundPayoff`] = payoff;
                        });

                        // Сохраняем результаты
                        updates[`history/round${currentRound}`] = {
                            actualCost,
                            totalContributions,
                            success,
                            contributions,
                            timestamp: Date.now()
                        };

                        updates['actualCost'] = actualCost;
                        updates['totalContributions'] = totalContributions;
                        updates['success'] = success;

                        database.ref(`rooms/${roomCode}`).update(updates).then(() => {
                            console.log('Results saved!');
                        });
                    });
                }
            });
        }

        // ЭКРАН 6: Результаты раунда
        function showRoundResults(roomData) {
            const players = roomData.players || {};
            const currentRound = roomData.currentRound;
            const actualCost = roomData.actualCost;
            const totalContributions = roomData.totalContributions;
            const success = roomData.success;

            const container = document.getElementById('gameContainer');
            container.innerHTML = `
                <h2 class="text-center mb-4">Результаты раунда ${currentRound}</h2>
                
                <div class="text-center mb-4">
                    <span class="${success ? 'success-badge' : 'fail-badge'}">
                        ${success ? '✅ Проект создан!' : '❌ Проект провален'}
                    </span>
                </div>

                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body text-center">
                                <h6 class="text-muted">Реальные издержки</h6>
                                <h3>${actualCost} монет</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body text-center">
                                <h6 class="text-muted">Сумма взносов группы</h6>
                                <h3>${totalContributions} монет</h3>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Игрок</th>
                                <th>Прогноз</th>
                                <th>Взнос</th>
                                <th>Выигрыш</th>
                                <th>Всего</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.entries(players).map(([pid, p]) => `
                                <tr ${pid === playerId ? 'class="table-primary"' : ''}>
                                    <td>${p.name} ${pid === playerId ? '(Вы)' : ''}</td>
                                    <td>${p.belief || '-'}</td>
                                    <td>${p.contribution || 0}</td>
                                    <td>${p.roundPayoff >= 0 ? '+' : ''}${p.roundPayoff}</td>
                                    <td><strong>${p.score}</strong></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>

                <div class="alert alert-${players[playerId].roundPayoff >= 0 ? 'success' : 'danger'}">
                    <strong>Ваш выигрыш в раунде:</strong> ${players[playerId].roundPayoff} монет<br>
                    <strong>Накопленный выигрыш:</strong> ${players[playerId].score} монет
                </div>

                <button class="btn btn-primary btn-lg w-100" onclick="nextRound()">
                    ${currentRound < GAME_PARAMS.numRounds ? 'Следующий раунд' : 'Финальные результаты'}
                </button>
            `;
        }

        function nextRound() {
            currentRoomRef.once('value', snapshot => {
                const roomData = snapshot.val();
                const currentRound = roomData.currentRound;

                if (currentRound >= GAME_PARAMS.numRounds) {
                    // Игра окончена
                    database.ref(`rooms/${roomCode}`).update({
                        status: 'finished'
                    });
                    return;
                }

                // Следующий раунд
                const updates = {
                    currentRound: currentRound + 1,
                    roundResults: null,
                    actualCost: null,
                    totalContributions: null,
                    success: null
                };

                // Сбрасываем готовность и данные раунда
                Object.keys(roomData.players).forEach(pid => {
                    updates[`players/${pid}/ready`] = false;
                    updates[`players/${pid}/belief`] = null;
                    updates[`players/${pid}/contribution`] = null;
                    updates[`players/${pid}/roundPayoff`] = null;
                });

                database.ref(`rooms/${roomCode}`).update(updates);
            });
        }

        // ЭКРАН 7: Финальные результаты
        function showFinalResults(roomData) {
            const players = roomData.players || {};
            const history = roomData.history || {};
            const sortedPlayers = Object.entries(players).sort((a, b) => b[1].score - a[1].score);
            const successCount = Object.values(history).filter(h => h.success).length;

            const container = document.getElementById('gameContainer');
            container.innerHTML = `
                <h1 class="text-center mb-4">🎉 Игра завершена!</h1>

                <div class="card mb-4">
                    <div class="card-body">
                        <h4 class="text-center">Итоговая таблица</h4>
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Место</th>
                                    <th>Игрок</th>
                                    <th>Итоговый счет</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sortedPlayers.map(([pid, p], index) => `
                                    <tr ${pid === playerId ? 'class="table-primary"' : ''}>
                                        <td><strong>${index + 1}</strong></td>
                                        <td>${p.name} ${pid === playerId ? '(Вы)' : ''}</td>
                                        <td><h5>${p.score} монет</h5></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <h6 class="text-muted">Общий выигрыш</h6>
                                <h3>${players[playerId].score} монет</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <h6 class="text-muted">Средний выигрыш за раунд</h6>
                                <h3>${(players[playerId].score / GAME_PARAMS.numRounds).toFixed(1)} монет</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <h6 class="text-muted">Успешных проектов</h6>
                                <h3>${successCount} из ${GAME_PARAMS.numRounds}</h3>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-body">
                        <h5>История раундов</h5>
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Раунд</th>
                                    <th>Прогноз</th>
                                    <th>Взнос</th>
                                    <th>Реальные издержки</th>
                                    <th>Сумма группы</th>
                                    <th>Статус</th>
                                    <th>Выигрыш</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.entries(history).map(([round, data]) => {
                                    const roundNum = parseInt(round.replace('round', ''));
                                    const myContribution = data.contributions[playerId] || 0;
                                    const myPayoff = data.success ? (50 - myContribution) : -myContribution;
                                    return `
                                        <tr>
                                            <td>${roundNum}</td>
                                            <td>-</td>
                                            <td>${myContribution}</td>
                                            <td>${data.actualCost}</td>
                                            <td>${data.totalContributions}</td>
                                            <td>${data.success ? '✅' : '❌'}</td>
                                            <td>${myPayoff >= 0 ? '+' : ''}${myPayoff}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="d-grid gap-2">
                    <button class="btn btn-primary btn-lg" onclick="downloadCSV()">Скачать результаты (CSV)</button>
                    <button class="btn btn-outline-secondary" onclick="playAgain()">Играть снова</button>
                </div>
            `;
        }

        function downloadCSV() {
            currentRoomRef.once('value', snapshot => {
                const roomData = snapshot.val();
                const players = roomData.players;
                const history = roomData.history || {};

                let csv = 'RoomCode,PlayerId,PlayerName,Round,Belief,Contribution,ActualCost,TotalContributions,Success,RoundPayoff,TotalScore\n';

                Object.entries(history).forEach(([roundKey, data]) => {
                    const roundNum = parseInt(roundKey.replace('round', ''));
                    Object.entries(players).forEach(([pid, p]) => {
                        const contrib = data.contributions[pid] || 0;
                        const payoff = data.success ? (50 - contrib) : -contrib;
                        csv += `${roomCode},${pid},${p.name},${roundNum},-,${contrib},${data.actualCost},${data.totalContributions},${data.success},${payoff},${p.score}\n`;
                    });
                });

                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `results_${roomCode}_${Date.now()}.csv`;
                a.click();
            });
        }

        function playAgain() {
            if (currentRoomRef) {
                currentRoomRef.off();
            }
            showHomeScreen();
        }

        // Инициализация
        showHomeScreen();
    </script>
</body>
</html>
