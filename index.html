<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ò–≥—Ä–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∏–∑–¥–µ—Ä–∂–µ–∫</title>
    <style>
        :root {
            --color-white: rgba(255, 255, 255, 1);
            --color-black: rgba(0, 0, 0, 1);
            --color-cream-50: rgba(252, 252, 249, 1);
            --color-cream-100: rgba(255, 255, 253, 1);
            --color-gray-200: rgba(245, 245, 245, 1);
            --color-gray-300: rgba(167, 169, 169, 1);
            --color-gray-400: rgba(119, 124, 124, 1);
            --color-slate-500: rgba(98, 108, 113, 1);
            --color-brown-600: rgba(94, 82, 64, 1);
            --color-charcoal-700: rgba(31, 33, 33, 1);
            --color-charcoal-800: rgba(38, 40, 40, 1);
            --color-slate-900: rgba(19, 52, 59, 1);
            --color-teal-300: rgba(50, 184, 198, 1);
            --color-teal-400: rgba(45, 166, 178, 1);
            --color-teal-500: rgba(33, 128, 141, 1);
            --color-teal-600: rgba(29, 116, 128, 1);
            --color-teal-700: rgba(26, 104, 115, 1);
            --color-teal-800: rgba(41, 150, 161, 1);
            --color-red-400: rgba(255, 84, 89, 1);
            --color-red-500: rgba(192, 21, 47, 1);
            --color-orange-400: rgba(230, 129, 97, 1);
            --color-orange-500: rgba(168, 75, 47, 1);
            --color-brown-600-rgb: 94, 82, 64;
            --color-teal-500-rgb: 33, 128, 141;
            --color-slate-900-rgb: 19, 52, 59;
            --color-slate-500-rgb: 98, 108, 113;
            --color-red-500-rgb: 192, 21, 47;
            --color-red-400-rgb: 255, 84, 89;
            --color-orange-500-rgb: 168, 75, 47;
            --color-orange-400-rgb: 230, 129, 97;
            --color-bg-1: rgba(59, 130, 246, 0.08);
            --color-bg-2: rgba(245, 158, 11, 0.08);
            --color-bg-3: rgba(34, 197, 94, 0.08);
            --color-bg-4: rgba(239, 68, 68, 0.08);
            --color-bg-5: rgba(147, 51, 234, 0.08);
            --color-bg-6: rgba(249, 115, 22, 0.08);
            --color-bg-7: rgba(236, 72, 153, 0.08);
            --color-bg-8: rgba(6, 182, 212, 0.08);
            --color-background: var(--color-cream-50);
            --color-surface: var(--color-cream-100);
            --color-text: var(--color-slate-900);
            --color-text-secondary: var(--color-slate-500);
            --color-primary: var(--color-teal-500);
            --color-primary-hover: var(--color-teal-600);
            --color-primary-active: var(--color-teal-700);
            --color-secondary: rgba(var(--color-brown-600-rgb), 0.12);
            --color-secondary-hover: rgba(var(--color-brown-600-rgb), 0.2);
            --color-secondary-active: rgba(var(--color-brown-600-rgb), 0.25);
            --color-border: rgba(var(--color-brown-600-rgb), 0.2);
            --color-btn-primary-text: var(--color-cream-50);
            --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);
            --color-card-border-inner: rgba(var(--color-brown-600-rgb), 0.12);
            --color-error: var(--color-red-500);
            --color-success: var(--color-teal-500);
            --color-warning: var(--color-orange-500);
            --color-info: var(--color-slate-500);
            --color-focus-ring: rgba(var(--color-teal-500-rgb), 0.4);
            --color-select-caret: rgba(var(--color-slate-900-rgb), 0.8);
            --focus-ring: 0 0 0 3px var(--color-focus-ring);
            --focus-outline: 2px solid var(--color-primary);
            --font-family-base: "FKGroteskNeue", "Geist", "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            --font-size-base: 14px;
            --font-size-sm: 12px;
            --font-size-lg: 16px;
            --font-size-xl: 18px;
            --font-size-2xl: 20px;
            --font-size-3xl: 24px;
            --font-weight-normal: 400;
            --font-weight-medium: 500;
            --font-weight-semibold: 550;
            --font-weight-bold: 600;
            --space-8: 8px;
            --space-12: 12px;
            --space-16: 16px;
            --space-20: 20px;
            --space-24: 24px;
            --space-32: 32px;
            --radius-base: 8px;
            --radius-lg: 12px;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.04), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
            --duration-normal: 250ms;
            --ease-standard: cubic-bezier(0.16, 1, 0.3, 1);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --color-gray-400-rgb: 119, 124, 124;
                --color-teal-300-rgb: 50, 184, 198;
                --color-gray-300-rgb: 167, 169, 169;
                --color-gray-200-rgb: 245, 245, 245;
                --color-bg-1: rgba(29, 78, 216, 0.15);
                --color-bg-2: rgba(180, 83, 9, 0.15);
                --color-bg-3: rgba(21, 128, 61, 0.15);
                --color-bg-4: rgba(185, 28, 28, 0.15);
                --color-bg-5: rgba(107, 33, 168, 0.15);
                --color-bg-6: rgba(194, 65, 12, 0.15);
                --color-bg-7: rgba(190, 24, 93, 0.15);
                --color-bg-8: rgba(8, 145, 178, 0.15);
                --color-background: var(--color-charcoal-700);
                --color-surface: var(--color-charcoal-800);
                --color-text: var(--color-gray-200);
                --color-text-secondary: rgba(var(--color-gray-300-rgb), 0.7);
                --color-primary: var(--color-teal-300);
                --color-primary-hover: var(--color-teal-400);
                --color-primary-active: var(--color-teal-800);
                --color-secondary: rgba(var(--color-gray-400-rgb), 0.15);
                --color-secondary-hover: rgba(var(--color-gray-400-rgb), 0.25);
                --color-secondary-active: rgba(var(--color-gray-400-rgb), 0.3);
                --color-border: rgba(var(--color-gray-400-rgb), 0.3);
                --color-error: var(--color-red-400);
                --color-success: var(--color-teal-300);
                --color-warning: var(--color-orange-400);
                --color-info: var(--color-gray-300);
                --color-focus-ring: rgba(var(--color-teal-300-rgb), 0.4);
                --color-btn-primary-text: var(--color-slate-900);
                --color-card-border: rgba(var(--color-gray-400-rgb), 0.2);
                --color-card-border-inner: rgba(var(--color-gray-400-rgb), 0.15);
            }
        }

        * {
            box-sizing: border-box;
        }

        html {
            font-size: var(--font-size-base);
            font-family: var(--font-family-base);
            color: var(--color-text);
            background-color: var(--color-background);
            -webkit-font-smoothing: antialiased;
        }

        body {
            margin: 0;
            padding: var(--space-20);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1, h2, h3 {
            margin: 0 0 var(--space-16) 0;
            font-weight: var(--font-weight-semibold);
        }

        h1 {
            font-size: var(--font-size-3xl);
            margin-bottom: var(--space-24);
        }

        h2 {
            font-size: var(--font-size-2xl);
        }

        h3 {
            font-size: var(--font-size-xl);
        }

        .card {
            background-color: var(--color-surface);
            border-radius: var(--radius-lg);
            border: 1px solid var(--color-card-border);
            box-shadow: var(--shadow-sm);
            padding: var(--space-24);
            margin-bottom: var(--space-20);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: var(--space-12) var(--space-24);
            border-radius: var(--radius-base);
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-medium);
            cursor: pointer;
            transition: all var(--duration-normal) var(--ease-standard);
            border: none;
            text-decoration: none;
        }

        .btn--primary {
            background: var(--color-primary);
            color: var(--color-btn-primary-text);
        }

        .btn--primary:hover {
            background: var(--color-primary-hover);
        }

        .btn--primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn--secondary {
            background: var(--color-secondary);
            color: var(--color-text);
        }

        .btn--secondary:hover {
            background: var(--color-secondary-hover);
        }

        .form-group {
            margin-bottom: var(--space-16);
        }

        .form-label {
            display: block;
            margin-bottom: var(--space-8);
            font-weight: var(--font-weight-medium);
            font-size: var(--font-size-base);
        }

        .form-control {
            display: block;
            width: 100%;
            padding: var(--space-12);
            font-size: var(--font-size-base);
            color: var(--color-text);
            background-color: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            transition: border-color var(--duration-normal) var(--ease-standard);
        }

        .form-control:focus {
            border-color: var(--color-primary);
            outline: var(--focus-outline);
        }

        .status {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: var(--font-weight-medium);
            font-size: var(--font-size-sm);
        }

        .status--success {
            background-color: rgba(var(--color-teal-500-rgb), 0.15);
            color: var(--color-success);
            border: 1px solid rgba(var(--color-teal-500-rgb), 0.25);
        }

        .status--error {
            background-color: rgba(var(--color-red-500-rgb), 0.15);
            color: var(--color-error);
            border: 1px solid rgba(var(--color-red-500-rgb), 0.25);
        }

        .status--info {
            background-color: rgba(var(--color-slate-500-rgb), 0.15);
            color: var(--color-info);
            border: 1px solid rgba(var(--color-slate-500-rgb), 0.25);
        }

        .grid {
            display: grid;
            gap: var(--space-16);
        }

        .grid--2 {
            grid-template-columns: repeat(2, 1fr);
        }

        .grid--4 {
            grid-template-columns: repeat(4, 1fr);
        }

        .player-card {
            padding: var(--space-16);
            background: var(--color-bg-1);
            border-radius: var(--radius-base);
            border: 1px solid var(--color-card-border);
        }

        .player-card.current-player {
            border: 2px solid var(--color-primary);
            background: rgba(var(--color-teal-500-rgb), 0.08);
        }

        .waiting-indicator {
            display: flex;
            align-items: center;
            gap: var(--space-8);
            padding: var(--space-12);
            background: var(--color-bg-2);
            border-radius: var(--radius-base);
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--color-border);
            border-top-color: var(--color-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        .range-container {
            display: flex;
            align-items: center;
            gap: var(--space-12);
        }

        .range-value {
            min-width: 50px;
            font-weight: var(--font-weight-bold);
            font-size: var(--font-size-lg);
            color: var(--color-primary);
        }

        input[type="range"] {
            flex: 1;
            height: 8px;
            border-radius: 4px;
            background: var(--color-secondary);
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--color-primary);
            cursor: pointer;
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--color-primary);
            cursor: pointer;
            border: none;
        }

        .radio-group {
            display: flex;
            gap: var(--space-12);
            flex-wrap: wrap;
        }

        .radio-label {
            display: flex;
            align-items: center;
            gap: var(--space-8);
            padding: var(--space-8) var(--space-16);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            cursor: pointer;
            transition: all var(--duration-normal) var(--ease-standard);
        }

        .radio-label:hover {
            background: var(--color-secondary);
        }

        .radio-label input[type="radio"] {
            margin: 0;
        }

        .radio-label input[type="radio"]:checked + span {
            font-weight: var(--font-weight-bold);
            color: var(--color-primary);
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: var(--space-16);
        }

        .results-table th,
        .results-table td {
            padding: var(--space-12);
            text-align: left;
            border-bottom: 1px solid var(--color-card-border);
        }

        .results-table th {
            font-weight: var(--font-weight-semibold);
            background: var(--color-bg-1);
        }

        .results-table tr:hover {
            background: var(--color-bg-2);
        }

        .score-display {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-bold);
            color: var(--color-primary);
            text-align: center;
            padding: var(--space-20);
        }

        @media (max-width: 768px) {
            .grid--4 {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .grid--2 {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéÆ –ò–≥—Ä–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∏–∑–¥–µ—Ä–∂–µ–∫</h1>

        <!-- Lobby Screen -->
        <div id="lobbyScreen">
            <div class="card">
                <h2>–°–æ–∑–¥–∞—Ç—å –∏–ª–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∏–≥—Ä–µ</h2>
                <div class="form-group">
                    <label class="form-label" for="playerName">–í–∞—à–µ –∏–º—è</label>
                    <input type="text" id="playerName" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è" maxlength="20">
                </div>
                <div class="form-group">
                    <label class="form-label" for="roomId">ID –∫–æ–º–Ω–∞—Ç—ã</label>
                    <input type="text" id="roomId" class="form-control" placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–π">
                </div>
                <button id="joinBtn" class="btn btn--primary">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
            </div>
        </div>

        <!-- Waiting Room -->
        <div id="waitingScreen" class="hidden">
            <div class="card">
                <h2>–ö–æ–º–Ω–∞—Ç–∞: <span id="currentRoomId"></span></h2>
                <p>–û–∂–∏–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤... (<span id="playerCount">0</span>/4)</p>
                <div id="playersList" class="grid grid--2"></div>
                <button id="startGameBtn" class="btn btn--primary hidden">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
            </div>
        </div>

        <!-- Game Screen -->
        <div id="gameScreen" class="hidden">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-16);">
                    <h2>–†–∞—É–Ω–¥ <span id="currentRound">1</span>/5</h2>
                    <div class="score-display">–í–∞—à —Å—á—ë—Ç: <span id="playerScore">0</span></div>
                </div>
                
                <div id="forecastPhase">
                    <h3>–®–∞–≥ 1: –ü—Ä–æ–≥–Ω–æ–∑ —Å—Ç–æ–∏–º–æ—Å—Ç–∏</h3>
                    <p style="color: var(--color-text-secondary); margin-bottom: var(--space-16);">
                        –ö–∞–∫—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø—Ä–æ–µ–∫—Ç–∞ –≤—ã –æ–∂–∏–¥–∞–µ—Ç–µ –≤ —ç—Ç–æ–º —Ä–∞—É–Ω–¥–µ?
                    </p>
                    <div class="form-group">
                        <div class="radio-group">
                            <label class="radio-label">
                                <input type="radio" name="forecast" value="60">
                                <span>60</span>
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="forecast" value="80">
                                <span>80</span>
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="forecast" value="100" checked>
                                <span>100</span>
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="forecast" value="120">
                                <span>120</span>
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="forecast" value="140">
                                <span>140</span>
                            </label>
                        </div>
                    </div>
                    <button id="submitForecastBtn" class="btn btn--primary">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø—Ä–æ–≥–Ω–æ–∑</button>
                </div>

                <div id="contributionPhase" class="hidden">
                    <h3>–®–∞–≥ 2: –í–∞—à –≤–∫–ª–∞–¥</h3>
                    <p style="color: var(--color-text-secondary); margin-bottom: var(--space-16);">
                        –°–∫–æ–ª—å–∫–æ –º–æ–Ω–µ—Ç –≤—ã –≥–æ—Ç–æ–≤—ã –≤–Ω–µ—Å—Ç–∏? (0-100)
                    </p>
                    <div class="form-group">
                        <div class="range-container">
                            <input type="range" id="contributionSlider" min="0" max="100" value="50" step="1">
                            <span class="range-value" id="contributionValue">50</span>
                        </div>
                    </div>
                    <button id="submitContributionBtn" class="btn btn--primary">–í–Ω–µ—Å—Ç–∏ –≤–∫–ª–∞–¥</button>
                </div>

                <div id="waitingPhase" class="hidden">
                    <div class="waiting-indicator">
                        <div class="spinner"></div>
                        <span>–û–∂–∏–¥–∞–Ω–∏–µ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤...</span>
                    </div>
                </div>

                <div id="resultsPhase" class="hidden">
                    <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—É–Ω–¥–∞</h3>
                    <div class="grid grid--2" style="margin-bottom: var(--space-20);">
                        <div class="card">
                            <strong>–†–µ–∞–ª—å–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:</strong> <span id="actualCost"></span>
                        </div>
                        <div class="card">
                            <strong>–û–±—â–∏–π –≤–∫–ª–∞–¥:</strong> <span id="totalContribution"></span>
                        </div>
                        <div class="card">
                            <strong>–°—Ç–∞—Ç—É—Å:</strong> <span id="roundStatus"></span>
                        </div>
                        <div class="card">
                            <strong>–í–∞—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç:</strong> <span id="roundProfit"></span>
                        </div>
                    </div>

                    <h4>–í–∫–ª–∞–¥—ã –∏–≥—Ä–æ–∫–æ–≤:</h4>
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>–ò–≥—Ä–æ–∫</th>
                                <th>–ü—Ä–æ–≥–Ω–æ–∑</th>
                                <th>–í–∫–ª–∞–¥</th>
                                <th>–†–µ–∑—É–ª—å—Ç–∞—Ç</th>
                            </tr>
                        </thead>
                        <tbody id="playersResultsTable"></tbody>
                    </table>

                    <button id="nextRoundBtn" class="btn btn--primary" style="margin-top: var(--space-20);">–°–ª–µ–¥—É—é—â–∏–π —Ä–∞—É–Ω–¥</button>
                </div>
            </div>
        </div>

        <!-- Final Results -->
        <div id="finalScreen" class="hidden">
            <div class="card">
                <h2>üèÜ –ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</h2>
                <div class="score-display">–í–∞—à –∏—Ç–æ–≥–æ–≤—ã–π —Å—á—ë—Ç: <span id="finalScore">0</span></div>
                
                <h3>–ò—Ç–æ–≥–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞:</h3>
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>–ú–µ—Å—Ç–æ</th>
                            <th>–ò–≥—Ä–æ–∫</th>
                            <th>–ò—Ç–æ–≥–æ–≤—ã–π —Å—á—ë—Ç</th>
                        </tr>
                    </thead>
                    <tbody id="finalResultsTable"></tbody>
                </table>

                <button id="newGameBtn" class="btn btn--primary" style="margin-top: var(--space-20);">–ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, get, onValue, update, push, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBdqtRnPhfqgYJYSMR5TZucmVHTuE4WTY8",
            authDomain: "cost-sharing-game.firebaseapp.com",
            databaseURL: "https://cost-sharing-game-default-rtdb.firebaseio.com",
            projectId: "cost-sharing-game",
            storageBucket: "cost-sharing-game.firebasestorage.app",
            messagingSenderId: "882128282715",
            appId: "1:882128282715:web:2fc86b8c68cbf3ccc44b7e"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let currentPlayer = {
            id: null,
            name: '',
            roomId: null,
            score: 0
        };

        let gameState = {
            currentRound: 1,
            phase: 'forecast'
        };

        // Possible costs for random selection
        const possibleCosts = [60, 80, 100, 120, 140];

        // Generate unique player ID
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // Generate room code
        function generateRoomCode() {
            return Math.random().toString(36).substr(2, 6).toUpperCase();
        }

        // UI Elements
        const lobbyScreen = document.getElementById('lobbyScreen');
        const waitingScreen = document.getElementById('waitingScreen');
        const gameScreen = document.getElementById('gameScreen');
        const finalScreen = document.getElementById('finalScreen');

        const playerNameInput = document.getElementById('playerName');
        const roomIdInput = document.getElementById('roomId');
        const joinBtn = document.getElementById('joinBtn');
        const startGameBtn = document.getElementById('startGameBtn');

        const contributionSlider = document.getElementById('contributionSlider');
        const contributionValue = document.getElementById('contributionValue');
        const submitForecastBtn = document.getElementById('submitForecastBtn');
        const submitContributionBtn = document.getElementById('submitContributionBtn');
        const nextRoundBtn = document.getElementById('nextRoundBtn');
        const newGameBtn = document.getElementById('newGameBtn');

        // Update contribution value display
        contributionSlider.addEventListener('input', (e) => {
            contributionValue.textContent = e.target.value;
        });

        // Join or create room
        joinBtn.addEventListener('click', async () => {
            const name = playerNameInput.value.trim();
            if (!name) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è');
                return;
            }

            currentPlayer.id = generateId();
            currentPlayer.name = name;

            let roomId = roomIdInput.value.trim().toUpperCase();
            
            if (!roomId) {
                // Create new room
                roomId = generateRoomCode();
                currentPlayer.roomId = roomId;
                
                await set(ref(db, `rooms/${roomId}`), {
                    status: 'waiting',
                    currentRound: 1,
                    phase: 'forecast',
                    host: currentPlayer.id
                });
            } else {
                // Check if room exists
                const roomSnapshot = await get(ref(db, `rooms/${roomId}`));
                if (!roomSnapshot.exists()) {
                    alert('–ö–æ–º–Ω–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                    return;
                }
                
                const roomData = roomSnapshot.val();
                if (roomData.status !== 'waiting') {
                    alert('–ò–≥—Ä–∞ —É–∂–µ –Ω–∞—á–∞–ª–∞—Å—å');
                    return;
                }
                
                const playersSnapshot = await get(ref(db, `rooms/${roomId}/players`));
                if (playersSnapshot.exists() && Object.keys(playersSnapshot.val()).length >= 4) {
                    alert('–ö–æ–º–Ω–∞—Ç–∞ –ø–æ–ª–Ω–∞');
                    return;
                }
                
                currentPlayer.roomId = roomId;
            }

            // Add player to room
            await set(ref(db, `rooms/${roomId}/players/${currentPlayer.id}`), {
                name: currentPlayer.name,
                score: 0,
                ready: false
            });

            showWaitingScreen();
            listenToRoom();
        });

        // Show waiting screen
        function showWaitingScreen() {
            lobbyScreen.classList.add('hidden');
            waitingScreen.classList.remove('hidden');
            document.getElementById('currentRoomId').textContent = currentPlayer.roomId;
        }

        // Listen to room updates
        function listenToRoom() {
            const roomRef = ref(db, `rooms/${currentPlayer.roomId}`);
            
            onValue(roomRef, (snapshot) => {
                const data = snapshot.val();
                if (!data) return;

                const players = data.players || {};
                const playerCount = Object.keys(players).length;
                
                document.getElementById('playerCount').textContent = playerCount;
                
                // Update players list
                const playersList = document.getElementById('playersList');
                playersList.innerHTML = '';
                Object.entries(players).forEach(([id, player]) => {
                    const div = document.createElement('div');
                    div.className = 'player-card';
                    if (id === currentPlayer.id) {
                        div.classList.add('current-player');
                    }
                    div.innerHTML = `<strong>${player.name}</strong><br>–°—á—ë—Ç: ${player.score || 0}`;
                    playersList.appendChild(div);
                });

                // Show start button for host
                if (data.host === currentPlayer.id && playerCount === 4) {
                    startGameBtn.classList.remove('hidden');
                }

                // Game started
                if (data.status === 'playing') {
                    waitingScreen.classList.add('hidden');
                    gameScreen.classList.remove('hidden');
                    gameState.currentRound = data.currentRound || 1;
                    gameState.phase = data.phase || 'forecast';
                    updateGameUI();
                    listenToGameState();
                }

                // Game ended
                if (data.status === 'finished') {
                    showFinalResults(players);
                }
            });
        }

        // Start game
        startGameBtn.addEventListener('click', async () => {
            await update(ref(db, `rooms/${currentPlayer.roomId}`), {
                status: 'playing',
                currentRound: 1,
                phase: 'forecast'
            });
        });

        // Listen to game state changes
        function listenToGameState() {
            const roomRef = ref(db, `rooms/${currentPlayer.roomId}`);
            
            onValue(roomRef, async (snapshot) => {
                const data = snapshot.val();
                if (!data || data.status !== 'playing') return;

                gameState.currentRound = data.currentRound || 1;
                gameState.phase = data.phase || 'forecast';
                
                document.getElementById('currentRound').textContent = gameState.currentRound;
                
                const players = data.players || {};
                const playerData = players[currentPlayer.id];
                if (playerData) {
                    currentPlayer.score = playerData.score || 0;
                    document.getElementById('playerScore').textContent = currentPlayer.score;
                }

                updateGameUI();

                // Check if all players submitted
                if (gameState.phase === 'forecast') {
                    const allSubmitted = Object.values(players).every(p => 
                        data.rounds && data.rounds[gameState.currentRound] && 
                        data.rounds[gameState.currentRound].forecasts && 
                        data.rounds[gameState.currentRound].forecasts[Object.keys(players).find(id => players[id].name === p.name)]
                    );
                    
                    if (allSubmitted && data.host === currentPlayer.id) {
                        await update(ref(db, `rooms/${currentPlayer.roomId}`), {
                            phase: 'contribution'
                        });
                    }
                } else if (gameState.phase === 'contribution') {
                    const allSubmitted = Object.keys(players).every(playerId => 
                        data.rounds && data.rounds[gameState.currentRound] && 
                        data.rounds[gameState.currentRound].contributions && 
                        data.rounds[gameState.currentRound].contributions[playerId] !== undefined
                    );
                    
                    if (allSubmitted && data.host === currentPlayer.id) {
                        await calculateRoundResults(data);
                    }
                } else if (gameState.phase === 'results') {
                    showRoundResults(data);
                }
            });
        }

        // Update game UI based on phase
        function updateGameUI() {
            document.getElementById('forecastPhase').classList.add('hidden');
            document.getElementById('contributionPhase').classList.add('hidden');
            document.getElementById('waitingPhase').classList.add('hidden');
            document.getElementById('resultsPhase').classList.add('hidden');

            const roundRef = ref(db, `rooms/${currentPlayer.roomId}/rounds/${gameState.currentRound}`);
            
            get(roundRef).then(snapshot => {
                const roundData = snapshot.val() || {};
                
                if (gameState.phase === 'forecast') {
                    const hasForecast = roundData.forecasts && roundData.forecasts[currentPlayer.id];
                    if (hasForecast) {
                        document.getElementById('waitingPhase').classList.remove('hidden');
                    } else {
                        document.getElementById('forecastPhase').classList.remove('hidden');
                    }
                } else if (gameState.phase === 'contribution') {
                    const hasContribution = roundData.contributions && roundData.contributions[currentPlayer.id] !== undefined;
                    if (hasContribution) {
                        document.getElementById('waitingPhase').classList.remove('hidden');
                    } else {
                        document.getElementById('contributionPhase').classList.remove('hidden');
                    }
                } else if (gameState.phase === 'results') {
                    document.getElementById('resultsPhase').classList.remove('hidden');
                }
            });
        }

        // Submit forecast
        submitForecastBtn.addEventListener('click', async () => {
            const forecast = parseInt(document.querySelector('input[name="forecast"]:checked').value);
            
            await set(ref(db, `rooms/${currentPlayer.roomId}/rounds/${gameState.currentRound}/forecasts/${currentPlayer.id}`), forecast);
            
            document.getElementById('forecastPhase').classList.add('hidden');
            document.getElementById('waitingPhase').classList.remove('hidden');
        });

        // Submit contribution
        submitContributionBtn.addEventListener('click', async () => {
            const contribution = parseInt(contributionSlider.value);
            
            await set(ref(db, `rooms/${currentPlayer.roomId}/rounds/${gameState.currentRound}/contributions/${currentPlayer.id}`), contribution);
            
            document.getElementById('contributionPhase').classList.add('hidden');
            document.getElementById('waitingPhase').classList.remove('hidden');
        });

        // Calculate round results
        async function calculateRoundResults(roomData) {
            const roundData = roomData.rounds[gameState.currentRound];
            const players = roomData.players;
            
            // Random cost
            const actualCost = possibleCosts[Math.floor(Math.random() * possibleCosts.length)];
            
            // Calculate total contribution
            const contributions = roundData.contributions || {};
            const totalContribution = Object.values(contributions).reduce((sum, c) => sum + c, 0);
            
            const success = totalContribution >= actualCost;
            
            // Calculate profits for each player
            const profits = {};
            Object.keys(players).forEach(playerId => {
                const contribution = contributions[playerId] || 0;
                profits[playerId] = success ? (50 - contribution) : -contribution;
            });
            
            // Update scores
            const updates = {};
            Object.keys(players).forEach(playerId => {
                const newScore = (players[playerId].score || 0) + profits[playerId];
                updates[`players/${playerId}/score`] = newScore;
            });
            
            updates[`rounds/${gameState.currentRound}/actualCost`] = actualCost;
            updates[`rounds/${gameState.currentRound}/totalContribution`] = totalContribution;
            updates[`rounds/${gameState.currentRound}/success`] = success;
            updates[`rounds/${gameState.currentRound}/profits`] = profits;
            updates.phase = 'results';
            
            await update(ref(db, `rooms/${currentPlayer.roomId}`), updates);
        }

        // Show round results
        function showRoundResults(roomData) {
            const roundData = roomData.rounds[gameState.currentRound];
            const players = roomData.players;
            
            document.getElementById('actualCost').textContent = roundData.actualCost;
            document.getElementById('totalContribution').textContent = roundData.totalContribution;
            
            const statusSpan = document.getElementById('roundStatus');
            if (roundData.success) {
                statusSpan.innerHTML = '<span class="status status--success">–£—Å–ø–µ—Ö ‚úì</span>';
            } else {
                statusSpan.innerHTML = '<span class="status status--error">–ü—Ä–æ–≤–∞–ª ‚úó</span>';
            }
            
            const profit = roundData.profits[currentPlayer.id];
            document.getElementById('roundProfit').textContent = profit > 0 ? `+${profit}` : profit;
            
            // Players results table
            const tbody = document.getElementById('playersResultsTable');
            tbody.innerHTML = '';
            
            Object.entries(players).forEach(([playerId, player]) => {
                const tr = document.createElement('tr');
                const forecast = roundData.forecasts[playerId] || '-';
                const contribution = roundData.contributions[playerId] || 0;
                const playerProfit = roundData.profits[playerId];
                
                tr.innerHTML = `
                    <td>${player.name}${playerId === currentPlayer.id ? ' (–í—ã)' : ''}</td>
                    <td>${forecast}</td>
                    <td>${contribution}</td>
                    <td style="color: ${playerProfit >= 0 ? 'var(--color-success)' : 'var(--color-error)'}">
                        ${playerProfit > 0 ? '+' : ''}${playerProfit}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Next round
        nextRoundBtn.addEventListener('click', async () => {
            const roomSnapshot = await get(ref(db, `rooms/${currentPlayer.roomId}`));
            const roomData = roomSnapshot.val();
            
            if (roomData.host !== currentPlayer.id) return;
            
            if (gameState.currentRound >= 5) {
                await update(ref(db, `rooms/${currentPlayer.roomId}`), {
                    status: 'finished'
                });
            } else {
                await update(ref(db, `rooms/${currentPlayer.roomId}`), {
                    currentRound: gameState.currentRound + 1,
                    phase: 'forecast'
                });
            }
        });

        // Show final results
        function showFinalResults(players) {
            gameScreen.classList.add('hidden');
            finalScreen.classList.remove('hidden');
            
            document.getElementById('finalScore').textContent = currentPlayer.score;
            
            const sorted = Object.entries(players).sort((a, b) => (b[1].score || 0) - (a[1].score || 0));
            
            const tbody = document.getElementById('finalResultsTable');
            tbody.innerHTML = '';
            
            sorted.forEach(([playerId, player], index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${player.name}${playerId === currentPlayer.id ? ' (–í—ã)' : ''}</td>
                    <td style="font-weight: var(--font-weight-bold); color: var(--color-primary);">
                        ${player.score || 0}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // New game
        newGameBtn.addEventListener('click', () => {
            location.reload();
        });
    </script>
</body>
</html>
